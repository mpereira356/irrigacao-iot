<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SmartFarm - Irriga√ß√£o Inteligente</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="sidebar">
    <h1>SmartFarm</h1>
    <p>Irriga√ß√£o Inteligente</p>
    
    <div id="listaDispositivos" style="margin-top: 20px;">
      <p style="font-size: 12px; opacity: 0.7;">Carregando dispositivos...</p>
    </div>
  </div>
  
  <div class="content">
    <div id="cabecalhoUsuario" style="display: flex; justify-content: space-between; align-items: center; margin: 20px;">
      <h2 id="boasVindas" style="margin: 0;"></h2>
      <button class="botao-logout" onclick="logout()">Sair</button>
    </div>
    
    <div id="mensagemSemDispositivo" style="text-align: center; margin-top: 50px; display: none;">
      <h2>Nenhum dispositivo encontrado</h2>
      <p>Entre em contato com o administrador para vincular um dispositivo ESP32 √† sua conta.</p>
    </div>

    <div id="conteudoDispositivo">
      <div id="infoDispositivo" style="margin-bottom: 20px; padding: 15px; background-color: #122b26; border-radius: 10px;">
        <h3 id="nomeDispositivo" style="margin: 0 0 5px 0;">Carregando...</h3>
        <p id="serialDispositivo" style="margin: 0; font-size: 12px; opacity: 0.7;">Serial: ---</p>
      </div>

      <div class="cards">
        <div class="card">
          <h2>Umidade do Solo</h2>
          <p id="umidadeSolo">--%</p>
          <small id="umidadeSoloBruto" style="font-size: 11px; opacity: 0.7;">Valor bruto: ---</small>
        </div>
        <div class="card">
          <h2>Umidade do Ar</h2>
          <p id="umidadeAr">--%</p>
        </div>
        <div class="card">
          <h2>Temperatura</h2>
          <p id="temperatura">--¬∞C</p>
        </div>
        <div class="card">
          <h2>Cultura</h2>
          <p id="culturaNome">---</p>
        </div>
        <div class="card">
          <h2>√Ågua Necess√°ria</h2>
          <p id="aguaNecessaria">-- L/m¬≤</p>
        </div>
        <div class="card">
          <h2>Frequ√™ncia Irriga√ß√£o</h2>
          <p id="frequenciaIrrigacao">-- dias</p>
        </div>
        <div class="card">
          <h2>√öltima Atualiza√ß√£o</h2>
          <p id="ultimaAtualizacao">---</p>
        </div>
        <div class="card">
          <h2>Status</h2>
          <p id="statusDispositivo">üü¢ Online</p>
        </div>
      </div>

      <h2>Hist√≥rico de Umidade do Solo (√öltimas 24h)</h2>
      <canvas id="chart" width="600" height="300"></canvas>
    </div>
  </div>

  <script>
    let usuarioAtual = null;
    let usuarioId = null;
    let dispositivoAtual = null;
    let chart = null;

    // Inicializar gr√°fico vazio
    const ctx = document.getElementById('chart').getContext('2d');
    chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'Umidade do Solo (%)',
          data: [],
          borderColor: '#00ffc3',
          backgroundColor: 'transparent',
          tension: 0.3
        }]
      },
      options: {
        scales: {
          y: {
            beginAtZero: true,
            max: 100
          }
        },
        plugins: {
          legend: {
            labels: {
              color: '#00ffc3'
            }
          }
        }
      }
    });

    // =====================
    // VERIFICA√á√ÉO DE SESS√ÉO SEGURA
    // =====================
    async function verificarSessao() {
      try {
        const response = await fetch('/session', {
          credentials: 'include'
        });
        const data = await response.json();
        
        if (!data.authenticated) {
          // N√£o autenticado - redirecionar para login
          alert('Voc√™ precisa fazer login para acessar esta p√°gina.');
          window.location.href = '/login.html';
          return null;
        }
        
        return data.user;
      } catch (error) {
        console.error('Erro ao verificar sess√£o:', error);
        alert('Erro ao verificar autentica√ß√£o. Redirecionando para login...');
        window.location.href = '/login.html';
        return null;
      }
    }

    // Inicializar p√°gina
    async function inicializar() {
      // Verificar sess√£o
      const user = await verificarSessao();
      if (!user) return;
      
      usuarioAtual = user.usuario;
      usuarioId = user.id;
      
      document.getElementById('boasVindas').innerHTML = `Bem vindo <strong>${user.nome}</strong>`;
      
      // Carregar dispositivos do usu√°rio
      carregarDispositivos();
    }

    function carregarDispositivos() {
      if (!usuarioId) return;
      
      fetch(`/esp32/dispositivos/${usuarioId}`, {
        credentials: 'include'
      })
        .then(res => {
          if (res.status === 401) {
            alert('Sess√£o expirada. Fa√ßa login novamente.');
            window.location.href = '/login.html';
            return;
          }
          return res.json();
        })
        .then(data => {
          if (!data) return;
          
          if (data.success && data.dispositivos.length > 0) {
            exibirListaDispositivos(data.dispositivos);
            document.getElementById('mensagemSemDispositivo').style.display = 'none';
            document.getElementById('conteudoDispositivo').style.display = 'block';
            
            // Selecionar o primeiro dispositivo por padr√£o
            selecionarDispositivo(data.dispositivos[0]);
          } else {
            document.getElementById('listaDispositivos').innerHTML = '<p style="font-size: 12px; opacity: 0.7; margin-top: 10px;">Nenhum dispositivo vinculado</p>';
            document.getElementById('mensagemSemDispositivo').style.display = 'block';
            document.getElementById('conteudoDispositivo').style.display = 'none';
          }
        })
        .catch(err => {
          console.error('Erro ao carregar dispositivos:', err);
          document.getElementById('listaDispositivos').innerHTML = '<p style="font-size: 12px; color: #ff4444;">Erro ao carregar dispositivos</p>';
        });
    }

    function exibirListaDispositivos(dispositivos) {
      const lista = document.getElementById('listaDispositivos');
      lista.innerHTML = '<h3 style="font-size: 14px; margin-bottom: 10px;">Meus Dispositivos</h3>';
      
      dispositivos.forEach(disp => {
        const item = document.createElement('div');
        item.className = 'dispositivo-item';
        item.dataset.dispositivoId = disp.id;
        item.innerHTML = `
          <div class="dispositivo-info">
            <strong>${disp.nome_cultura || 'Sem cultura'}</strong>
            <small>Serial: ${disp.serialnumber}</small>
          </div>
        `;
        item.onclick = () => selecionarDispositivo(disp);
        lista.appendChild(item);
      });
    }

    function selecionarDispositivo(dispositivo) {
      dispositivoAtual = dispositivo;
      
      // Destacar o dispositivo selecionado
      document.querySelectorAll('.dispositivo-item').forEach(item => {
        item.classList.remove('selecionado');
        if (item.dataset.dispositivoId == dispositivo.id) {
          item.classList.add('selecionado');
        }
      });
      
      // Atualizar informa√ß√µes do dispositivo
      document.getElementById('nomeDispositivo').innerText = dispositivo.nome_cultura || 'Sem cultura definida';
      document.getElementById('serialDispositivo').innerText = `Serial: ${dispositivo.serialnumber}`;
      document.getElementById('culturaNome').innerText = dispositivo.nome_cultura || '---';
      document.getElementById('aguaNecessaria').innerText = dispositivo.agua_necessaria ? `${dispositivo.agua_necessaria} L/m¬≤` : '---';
      document.getElementById('frequenciaIrrigacao').innerText = dispositivo.frequencia_irrigacao_dias ? `${dispositivo.frequencia_irrigacao_dias} dias` : '---';
      
      // Carregar dados dos sensores
      carregarDadosSensores(dispositivo.id);
      carregarHistorico(dispositivo.id);
      
      // Atualizar dados a cada 30 segundos
      if (window.intervalAtualizacao) {
        clearInterval(window.intervalAtualizacao);
      }
      window.intervalAtualizacao = setInterval(() => {
        carregarDadosSensores(dispositivo.id);
      }, 30000);
    }

    function carregarDadosSensores(dispositivoId) {
      fetch(`/esp32/sensores/${dispositivoId}/latest`, {
        credentials: 'include'
      })
        .then(res => {
          if (res.status === 401) {
            alert('Sess√£o expirada. Fa√ßa login novamente.');
            window.location.href = '/login.html';
            return;
          }
          return res.json();
        })
        .then(data => {
          if (!data) return;
          
          if (data.success && data.dados) {
            const d = data.dados;
            
            // Atualizar cards
            document.getElementById('umidadeSolo').innerText = d.umidade_solo_perc ? `${d.umidade_solo_perc}%` : '--%';
            document.getElementById('umidadeSoloBruto').innerText = `Valor bruto: ${d.umidade_solo_bruto || '---'}`;
            document.getElementById('umidadeAr').innerText = d.umidade_ar ? `${d.umidade_ar}%` : '--%';
            document.getElementById('temperatura').innerText = d.temperatura ? `${d.temperatura}¬∞C` : '--¬∞C';
            
            // √öltima atualiza√ß√£o
            if (d.update_em || d.criado_em) {
              const dataAtualizacao = new Date(d.update_em || d.criado_em);
              document.getElementById('ultimaAtualizacao').innerText = dataAtualizacao.toLocaleString('pt-BR');
              
              // Verificar se est√° online (√∫ltima atualiza√ß√£o h√° menos de 5 minutos)
              const minutos = (Date.now() - dataAtualizacao.getTime()) / 1000 / 60;
              if (minutos < 5) {
                document.getElementById('statusDispositivo').innerHTML = 'üü¢ Online';
              } else if (minutos < 30) {
                document.getElementById('statusDispositivo').innerHTML = 'üü° Inativo';
              } else {
                document.getElementById('statusDispositivo').innerHTML = 'üî¥ Offline';
              }
            } else {
              document.getElementById('ultimaAtualizacao').innerText = 'Sem dados';
              document.getElementById('statusDispositivo').innerHTML = '‚ö™ Sem dados';
            }
          } else {
            // Sem dados
            document.getElementById('umidadeSolo').innerText = '--%';
            document.getElementById('umidadeSoloBruto').innerText = 'Valor bruto: ---';
            document.getElementById('umidadeAr').innerText = '--%';
            document.getElementById('temperatura').innerText = '--¬∞C';
            document.getElementById('ultimaAtualizacao').innerText = 'Sem leituras';
            document.getElementById('statusDispositivo').innerHTML = '‚ö™ Sem dados';
          }
        })
        .catch(err => {
          console.error('Erro ao carregar dados dos sensores:', err);
        });
    }

    function carregarHistorico(dispositivoId) {
      fetch(`/esp32/sensores/${dispositivoId}/historico?horas=24`, {
        credentials: 'include'
      })
        .then(res => {
          if (res.status === 401) {
            alert('Sess√£o expirada. Fa√ßa login novamente.');
            window.location.href = '/login.html';
            return;
          }
          return res.json();
        })
        .then(data => {
          if (!data) return;
          
          if (data.success && data.historico.length > 0) {
            const labels = [];
            const valores = [];
            
            data.historico.forEach(leitura => {
              const data = new Date(leitura.criado_em);
              const hora = data.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
              labels.push(hora);
              valores.push(leitura.umidade_solo_perc || 0);
            });
            
            // Atualizar gr√°fico
            chart.data.labels = labels;
            chart.data.datasets[0].data = valores;
            chart.update();
          } else {
            // Sem hist√≥rico
            chart.data.labels = ['Sem dados'];
            chart.data.datasets[0].data = [0];
            chart.update();
          }
        })
        .catch(err => {
          console.error('Erro ao carregar hist√≥rico:', err);
        });
    }

    function logout() {
      if (window.intervalAtualizacao) {
        clearInterval(window.intervalAtualizacao);
      }
      
      fetch('/logout', {
        method: 'POST',
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json'
        }
      })
      .then(() => {
        localStorage.removeItem('usuarioLogado');
        window.location.href = '/login.html';
      })
      .catch(() => {
        localStorage.removeItem('usuarioLogado');
        window.location.href = '/login.html';
      });
    }

    // Inicializar ao carregar a p√°gina
    inicializar();
  </script>
</body>
</html>

