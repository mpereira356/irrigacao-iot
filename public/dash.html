<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SmartFarm - Irriga√ß√£o Inteligente</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* ====== Modal ====== */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      inset: 0;
      background: rgba(0,0,0,0.6);
    }
    .modal-content {
      background: #122b26;
      color: #fff;
      margin: 6% auto;
      padding: 20px;
      border-radius: 10px;
      width: 420px;
      max-width: calc(100% - 32px);
      position: relative;
      box-shadow: 0 20px 60px rgba(0,0,0,0.45);
    }
    .modal-content h2 { margin-top: 0; }
    .modal-content .close {
      position: absolute;
      top: 10px; right: 14px;
      font-size: 22px;
      cursor: pointer;
      opacity: .8;
    }
    .modal .form-group { margin-bottom: 14px; }
    .modal input[type="text"],
    .modal input[type="email"],
    .modal input[type="password"] {
      width: 100%;
      padding: 12px;
      border: 1px solid #2a4a42;
      border-radius: 6px;
      background: #0a1f1a;
      color: #fff;
      font-size: 14px;
      box-sizing: border-box;
    }
    .modal .btn {
      background: #00ffc3;
      color: #0a1f1a;
      border: 0;
      border-radius: 6px;
      padding: 10px 16px;
      font-weight: 700;
      cursor: pointer;
    }
    .modal .btn:hover { filter: brightness(.95); }

    .modal .alert {
      padding: 10px 12px;
      border-radius: 6px;
      margin-bottom: 14px;
      font-size: 14px;
      border: 1px solid transparent;
    }
    .modal .alert-success { background: #00ffc333; border-color: #00ffc3; color: #00ffc3; }
    .modal .alert-error   { background: #ff444433; border-color: #ff4444; color: #ff4444; }

    .divider-h {
      height: 1px;
      background: #2a4a42;
      margin: 18px 0;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <h1>SmartFarm</h1>
    <p>Irriga√ß√£o Inteligente</p>
    
    <button id="btnAddDisp" class="botao-add" style="margin-top:10px;margin-bottom:10px;background:#00ffc3;color:#0a1f1a;border:0;border-radius:6px;padding:10px 12px;font-weight:700;cursor:pointer">‚ûï Adicionar dispositivo</button>    
    <div id="listaDispositivos" style="margin-top: 20px;">
      <p style="font-size: 12px; opacity: 0.7;">Carregando dispositivos...</p>
    </div>
  </div>
  
  <div class="content">
    <div id="cabecalhoUsuario" style="display: flex; justify-content: space-between; align-items: center; margin: 20px;">
      <h2 id="boasVindas" style="margin: 0;"></h2>
      <div style="display: flex; gap: 10px;">
        <button id="btnAbrirConfig" class="botao-config" style="background-color: #2a4a42; color: #fff; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s;">‚öôÔ∏è Configura√ß√µes</button>


        <button class="botao-logout" onclick="logout()">Sair</button>
      </div>
    </div>
    
    <div id="mensagemSemDispositivo" style="text-align: center; margin-top: 50px; display: none;">
      <h2>Nenhum dispositivo encontrado</h2>
      <p>Entre em contato com o administrador para vincular um dispositivo ESP32 √† sua conta.</p>
    </div>

    <div id="conteudoDispositivo">
      <div id="infoDispositivo" style="margin-bottom: 20px; padding: 15px; background-color: #122b26; border-radius: 10px;">
        <h3 id="nomeDispositivo" style="margin: 0 0 5px 0;">Carregando...</h3>
        <p id="serialDispositivo" style="margin: 0; font-size: 12px; opacity: 0.7;">Serial: ---</p>

                <!-- Bot√£o Editar -->
        <button id="btnEditarDisp" class="botao-config" style="background:#2a4a42;color:#fff;padding:10px 20px;border:0;border-radius:5px;cursor:pointer;font-size:14px;font-weight:600">‚úèÔ∏è Editar</button>

      </div>

      <div class="cards">
        <div class="card">
          <h2>Umidade do Solo</h2>
          <p id="umidadeSolo">--%</p>
          <small id="umidadeSoloBruto" style="font-size: 11px; opacity: 0.7;">Valor bruto: ---</small>
        </div>
        <div class="card">
          <h2>Umidade do Ar</h2>
          <p id="umidadeAr">--%</p>
        </div>
        <div class="card">
          <h2>Temperatura</h2>
          <p id="temperatura">--¬∞C</p>
        </div>
        <div class="card">
          <h2>Cultura</h2>
          <p id="culturaNome">---</p>
        </div>
        <div class="card">
          <h2>√Ågua Necess√°ria</h2>
          <p id="aguaNecessaria">-- L/m¬≤</p>
        </div>
        <div class="card">
          <h2>Frequ√™ncia Irriga√ß√£o</h2>
          <p id="frequenciaIrrigacao">-- dias</p>
        </div>
        <div class="card">
          <h2>√öltima Atualiza√ß√£o</h2>
          <p id="ultimaAtualizacao">---</p>
        </div>
        <div class="card">
          <h2>Status</h2>
          <p id="statusDispositivo">üü¢ Online</p>
        </div>
        <div class="card">
          <h2>Pr√≥xima Irriga√ß√£o</h2>
          <p id="proximaIrrigacao">---</p>
          <small id="diasRestantes" style="font-size: 11px; opacity: 0.7;">---</small>
        </div>
        <div class="card">
          <h2>Quantidade de √Ågua</h2>
          <p id="quantidadeAgua">--- L</p>
          <small id="areaInfo" style="font-size: 11px; opacity: 0.7;">√Årea: --- m¬≤</small>
        </div>
      </div>

      <h2>Hist√≥rico de Umidade do Solo (√öltimas 24h)</h2>
      <canvas id="chart" width="600" height="300"></canvas>
    </div>
  </div>

  <!-- ================= Modal Configura√ß√µes ================= -->
  <div id="modalConfig" class="modal">
    <div class="modal-content">
      <span class="close" id="fecharModal">&times;</span>
      <h2>‚öôÔ∏è Configura√ß√µes da Conta</h2>

      <!-- NOVO: ID e Usu√°rio (somente leitura) -->
      <div class="form-group">
        <label for="cfgUserId">ID do Usu√°rio</label>
        <input type="text" id="cfgUserId" disabled>
      </div>
      <div class="form-group">
        <label for="cfgUsuario">Usu√°rio (login)</label>
        <input type="text" id="cfgUsuario" disabled>
      </div>

      <div id="alertConfig"></div>

      <!-- Editar Perfil -->
      <form id="formPerfil">
        <div class="form-group">
          <label for="cfgNome">Nome Completo</label>
          <input type="text" id="cfgNome" required>
        </div>

        <div class="form-group">
          <label for="cfgEmail">Email</label>
          <input type="email" id="cfgEmail" required>
        </div>

        <button type="submit" class="btn">Salvar Perfil</button>
      </form>

      <div class="divider-h"></div>

      <!-- Trocar Senha -->
      <form id="formSenha">
        <div class="form-group">
          <label for="cfgSenhaAtual">Senha Atual</label>
          <input type="password" id="cfgSenhaAtual" required>
        </div>

        <div class="form-group">
          <label for="cfgNovaSenha">Nova Senha</label>
          <input type="password" id="cfgNovaSenha" required minlength="6">
        </div>

        <div class="form-group">
          <label for="cfgConfirmarSenha">Confirmar Nova Senha</label>
          <input type="password" id="cfgConfirmarSenha" required minlength="6">
        </div>

        <button type="submit" class="btn">Alterar Senha</button>
      </form>
    </div>
  </div>

<div id="modalDispositivo" class="modal">
  <div class="modal-content">
    <span class="close" id="fecharModalDisp">&times;</span>
    <h2 id="tituloModalDisp">‚ûï Adicionar dispositivo</h2>
    <div id="alertDisp"></div>

    <form id="formDispositivo">
      <input type="hidden" id="dispId">

      <div class="form-group">
        <label for="dispSerial" style="font-weight:600;">Serial</label>
        <input
          id="dispSerial"
          name="serialnumber"
          type="text"
          class="campo-input"
          placeholder="Serial do dispositivo"

        />
      </div>

      <div class="form-group">
        <label for="dispCultura">Cultura *</label>
        <select id="dispCultura" required></select>
        <small class="hint" style="opacity:.7">
          Usado para √°gua (L/m¬≤) e frequ√™ncia de irriga√ß√£o.
        </small>
      </div>

      <div class="form-group">
        <label for="dispCEP">CEP *</label>
        <input type="text" id="dispCEP" placeholder="00000-000" required>
      </div>

      <div class="form-group">
        <label for="dispRua">Rua *</label>
        <input type="text" id="dispRua" required>
      </div>

      <div class="form-group">
        <label for="dispNumero">N√∫mero (opcional)</label>
        <input type="text" id="dispNumero">
      </div>

      <div class="form-group">
        <label for="dispBairro">Bairro *</label>
        <input type="text" id="dispBairro" required>
      </div>

      <div class="form-group">
        <label for="dispCidade">Cidade *</label>
        <input type="text" id="dispCidade" required>
      </div>

      <div class="form-group">
        <label for="dispEstado">Estado (UF) *</label>
        <input type="text" id="dispEstado" maxlength="2" required>
      </div>

      <small style="opacity:.7">A latitude/longitude ser√£o preenchidas automaticamente pelo endere√ßo.</small>

      <div style="margin-top:14px">
        <button type="submit" class="btn" id="btnSalvarDisp">Salvar</button>
      </div>

      <button type="button" id="btnExcluirDisp" class="btn" 
        style="background:#ff4444;color:#fff;margin-top:10px;display:none;">
        üóëÔ∏è Excluir dispositivo
      </button>

    </form>
  </div>
</div>


  <script>
    let usuarioAtual = null;
    let usuarioId = null;
    let dispositivoAtual = null;
    let chart = null;

    // Inicializar gr√°fico vazio
    const ctx = document.getElementById('chart').getContext('2d');
    chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'Umidade do Solo (%)',
          data: [],
          borderColor: '#00ffc3',
          backgroundColor: 'transparent',
          tension: 0.3
        }]
      },
      options: {
        scales: { y: { beginAtZero: true, max: 100 } },
        plugins: { legend: { labels: { color: '#00ffc3' } } }
      }
    });

    // =====================
    // VERIFICA√á√ÉO DE SESS√ÉO SEGURA
    // =====================
    async function verificarSessao() {
  try {
    const response = await fetch('/session', { credentials: 'include' });
    const data = await response.json();

    if (!data.authenticated) {
      alert('Voc√™ precisa fazer login para acessar esta p√°gina.');
      window.location.href = '/login.html';
      return null;
    }

    // aceita tanto data.user quanto campos soltos (usuario/nome/id/isAdmin)
    const user = data.user || {
      id: data.id,
      usuario: data.usuario,
      nome: data.nome,
      isAdmin: data.isAdmin
    };

    // se ainda faltar id, tenta pegar do localStorage como fallback
    if (!user || user.id == null) {
      const ls = JSON.parse(localStorage.getItem('usuarioLogado') || 'null');
      if (ls && ls.id != null) {
        user.id = ls.id;
        user.usuario = user.usuario || ls.usuario;
        user.nome = user.nome || ls.nome;
        user.isAdmin = user.isAdmin ?? ls.isAdmin;
      }
    }

    return user;
  } catch (error) {
    console.error('Erro ao verificar sess√£o:', error);
    alert('Falha ao verificar sess√£o. Fa√ßa login novamente.');
    window.location.href = '/login.html';
    return null;
  }
}

    // Inicializar p√°gina
    async function inicializar() {
      const user = await verificarSessao();
      if (!user) return;

      usuarioAtual = user.usuario;
      usuarioId = user.id;

      document.getElementById('boasVindas').innerHTML = `Bem vindo <strong>${user.nome}</strong>`;

      await carregarCulturas();          // <-- adicione aqui
      carregarDispositivos();
      prepararModalConfiguracoes();
    }

    // =====================
    // MODAL CONFIGURA√á√ïES
    // =====================
    function prepararModalConfiguracoes() {
      const modal = document.getElementById('modalConfig');
      const btnAbrir = document.getElementById('btnAbrirConfig');
      const btnFechar = document.getElementById('fecharModal');
      const alertBox = document.getElementById('alertConfig');

      function showAlert(msg, type='success') {
        alertBox.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
        setTimeout(() => { alertBox.innerHTML = ''; }, 5000);
      }

      btnAbrir.onclick = async () => {
        await preencherPerfilNoModal();
        modal.style.display = 'block';
      };
      btnFechar.onclick = () => modal.style.display = 'none';
      window.addEventListener('click', (e) => {
        if (e.target === modal) modal.style.display = 'none';
      });

      // Salvar Perfil
      document.getElementById('formPerfil').addEventListener('submit', async (e) => {
        e.preventDefault();
        const nome = document.getElementById('cfgNome').value;
        const email = document.getElementById('cfgEmail').value;

        try {
          const resp = await fetch('/usuario/perfil', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ nome, email })
          });
          const data = await resp.json();
          if (data.success) {
            showAlert('Perfil atualizado com sucesso!', 'success');
            document.getElementById('boasVindas').innerHTML = `Bem vindo <strong>${nome}</strong>`;
          } else {
            showAlert(data.message || 'Erro ao atualizar perfil', 'error');
          }
        } catch (err) {
          console.error(err);
          showAlert('Erro ao salvar perfil', 'error');
        }
      });

      // Trocar senha
      document.getElementById('formSenha').addEventListener('submit', async (e) => {
        e.preventDefault();
        const senhaAtual = document.getElementById('cfgSenhaAtual').value;
        const novaSenha = document.getElementById('cfgNovaSenha').value;
        const confirmarSenha = document.getElementById('cfgConfirmarSenha').value;

        if (novaSenha !== confirmarSenha) {
          showAlert('A nova senha e a confirma√ß√£o n√£o coincidem', 'error');
          return;
        }

        try {
          const resp = await fetch('/usuario/senha', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ senhaAtual, novaSenha, confirmarSenha })
          });
          const data = await resp.json();
          if (data.success) {
            showAlert('Senha alterada com sucesso!', 'success');
            document.getElementById('formSenha').reset();
          } else {
            showAlert(data.message || 'Erro ao alterar senha', 'error');
          }
        } catch (err) {
          console.error(err);
          showAlert('Erro ao alterar senha', 'error');
        }
      });
    }

    async function preencherPerfilNoModal() {
      try {
        const resp = await fetch('/usuario/perfil', { credentials: 'include' });
        if (resp.status === 401) {
          alert('Sess√£o expirada. Fa√ßa login novamente.');
          window.location.href = '/login.html';
          return;
        }
        const data = await resp.json();
        // preencher a partir da API
        if (data.success && data.perfil) {
          document.getElementById('cfgNome').value   = data.perfil.nome   || '';
          document.getElementById('cfgEmail').value  = data.perfil.email  || '';
          const idEl  = document.getElementById('cfgUserId');
          const usuEl = document.getElementById('cfgUsuario');
          if (idEl)  idEl.value  = data.perfil.id ?? '';
          if (usuEl) usuEl.value = data.perfil.usuario || '';
        }
        // fallback com dados da sess√£o (garante exibi√ß√£o mesmo se a API n√£o retornar)
        const idEl  = document.getElementById('cfgUserId');
        const usuEl = document.getElementById('cfgUsuario');
        if (idEl && !idEl.value)  idEl.value  = usuarioId ?? '';
        if (usuEl && !usuEl.value) usuEl.value = usuarioAtual ?? '';
      } catch (err) {
        console.error('Erro ao carregar perfil no modal:', err);
        // fallback
        const idEl  = document.getElementById('cfgUserId');
        const usuEl = document.getElementById('cfgUsuario');
        if (idEl)  idEl.value  = usuarioId ?? '';
        if (usuEl) usuEl.value = usuarioAtual ?? '';
      }
    }

        // Carrega lista de culturas para o <select>
    async function carregarCulturas() {
      const sel = document.getElementById('dispCultura');
      sel.innerHTML = '<option value="">Carregando...</option>';
      try {
        const r = await fetch('/culturas', { credentials:'include' }); // ou /api/culturas se usar o alias
        const j = await r.json();
        if (!r.ok || !j.success) throw new Error(j.message || 'Falha ao carregar culturas');

        if (!j.culturas || j.culturas.length === 0) {
          sel.innerHTML = '<option value="">Nenhuma cultura cadastrada</option>';
          return;
        }

        sel.innerHTML = '<option value="">Selecione...</option>';
        j.culturas.forEach(c => {
          const opt = document.createElement('option');
          opt.value = c.id;
          opt.textContent = c.cultura;
          sel.appendChild(opt);
        });
      } catch (e) {
        console.error('Erro ao carregar culturas:', e);
        sel.innerHTML = '<option value="">Erro ao carregar</option>';
      }
    }

    // =====================
    // DADOS / LISTAGEM / PROJE√á√ÉO
    // =====================
    function carregarDispositivos() {
      if (!usuarioId) return;
      fetch(`/esp32/dispositivos/${usuarioId}`, { credentials: 'include' })
        .then(res => {
          if (res.status === 401) {
            alert('Sess√£o expirada. Fa√ßa login novamente.');
            window.location.href = '/login.html';
            return;
          }
          return res.json();
        })
        .then(data => {
          if (!data) return;
          if (data.success && data.dispositivos.length > 0) {
            exibirListaDispositivos(data.dispositivos);
            document.getElementById('mensagemSemDispositivo').style.display = 'none';
            document.getElementById('conteudoDispositivo').style.display = 'block';
            selecionarDispositivo(data.dispositivos[0]);
          } else {
            document.getElementById('listaDispositivos').innerHTML =
              '<p style="font-size: 12px; opacity: 0.7; margin-top: 10px;">Nenhum dispositivo vinculado</p>';
            document.getElementById('mensagemSemDispositivo').style.display = 'block';
            document.getElementById('conteudoDispositivo').style.display = 'none';
          }
        })
        .catch(err => {
          console.error('Erro ao carregar dispositivos:', err);
          document.getElementById('listaDispositivos').innerHTML =
            '<p style="font-size: 12px; color: #ff4444;">Erro ao carregar dispositivos</p>';
        });
    }

    function exibirListaDispositivos(dispositivos) {
      const lista = document.getElementById('listaDispositivos');
      lista.innerHTML = '<h3 style="font-size: 14px; margin-bottom: 10px;">Meus Dispositivos</h3>';

      dispositivos.forEach(disp => {
        const item = document.createElement('div');
        item.className = 'dispositivo-item';
        item.dataset.dispositivoId = disp.id;
        item.innerHTML = `
          <div class="dispositivo-info" style="display:flex;justify-content:space-between;align-items:center;">
            <div>
              <strong>${disp.nome_cultura || 'Sem cultura'}</strong><br>
              <small>Serial: ${disp.serialnumber}</small>
            </div>
            <button class="btn-remove" data-id="${disp.id}" 
              style="background:#ff4444;border:none;color:#fff;border-radius:4px;padding:4px 8px;cursor:pointer;">üóëÔ∏è</button>
          </div>`;
        item.onclick = () => selecionarDispositivo(disp);
        lista.appendChild(item);
      });

      // <-- AQUI, dentro da fun√ß√£o:
      lista.querySelectorAll('.btn-remove').forEach(btn=>{
        btn.addEventListener('click', async (e)=>{
          e.stopPropagation();
          const id = btn.dataset.id;
          if(!confirm('Deseja realmente excluir este dispositivo?')) return;
          const resp = await fetch(`/me/dispositivos/${id}`, {method:'DELETE', credentials:'include'});
          const data = await resp.json();
          if(resp.ok && data.success){
            alert('Dispositivo removido!');
            carregarDispositivos();
          } else {
            alert(data.message || 'Erro ao remover.');
          }
        });
      });
    }


    function selecionarDispositivo(dispositivo) {
      dispositivoAtual = dispositivo;
      document.querySelectorAll('.dispositivo-item').forEach(item => {
        item.classList.remove('selecionado');
        if (item.dataset.dispositivoId == dispositivo.id) item.classList.add('selecionado');
      });
      document.getElementById('nomeDispositivo').innerText = dispositivo.nome_cultura || 'Sem cultura definida';
      document.getElementById('serialDispositivo').innerText = `Serial: ${dispositivo.serialnumber}`;
      document.getElementById('culturaNome').innerText = dispositivo.nome_cultura || '---';
      document.getElementById('aguaNecessaria').innerText = dispositivo.agua_necessaria ? `${dispositivo.agua_necessaria} L/m¬≤` : '---';
      document.getElementById('frequenciaIrrigacao').innerText = dispositivo.frequencia_irrigacao_dias ? `${dispositivo.frequencia_irrigacao_dias} dias` : '---';

      carregarDadosSensores(dispositivo.id);
      carregarHistorico(dispositivo.id);
      carregarProjecaoIrrigacao(dispositivo.id);

      if (window.intervalAtualizacao) clearInterval(window.intervalAtualizacao);
      window.intervalAtualizacao = setInterval(() => {
        carregarDadosSensores(dispositivo.id);
        carregarProjecaoIrrigacao(dispositivo.id);
      }, 30000);
    }

    function carregarDadosSensores(dispositivoId) {
      fetch(`/esp32/sensores/${dispositivoId}/latest`, { credentials: 'include' })
        .then(res => {
          if (res.status === 401) {
            alert('Sess√£o expirada. Fa√ßa login novamente.');
            window.location.href = '/login.html';
            return;
          }
          return res.json();
        })
        .then(data => {
          if (!data) return;
          if (data.success && data.dados) {
            const d = data.dados;
            document.getElementById('umidadeSolo').innerText = d.umidade_solo_perc ? `${d.umidade_solo_perc}%` : '--%';
            document.getElementById('umidadeSoloBruto').innerText = `Valor bruto: ${d.umidade_solo_bruto || '---'}`;
            document.getElementById('umidadeAr').innerText = d.umidade_ar ? `${d.umidade_ar}%` : '--%';
            document.getElementById('temperatura').innerText = d.temperatura ? `${d.temperatura}¬∞C` : '--¬∞C';

            if (d.update_em || d.criado_em) {
              const dataAtualizacao = new Date(d.update_em || d.criado_em);
              document.getElementById('ultimaAtualizacao').innerText = dataAtualizacao.toLocaleString('pt-BR');

              const minutos = (Date.now() - dataAtualizacao.getTime()) / 1000 / 60;
              if (minutos < 5) document.getElementById('statusDispositivo').innerHTML = 'üü¢ Online';
              else if (minutos < 30) document.getElementById('statusDispositivo').innerHTML = 'üü° Inativo';
              else document.getElementById('statusDispositivo').innerHTML = 'üî¥ Offline';
            } else {
              document.getElementById('ultimaAtualizacao').innerText = 'Sem dados';
              document.getElementById('statusDispositivo').innerHTML = '‚ö™ Sem dados';
            }
          } else {
            document.getElementById('umidadeSolo').innerText = '--%';
            document.getElementById('umidadeSoloBruto').innerText = 'Valor bruto: ---';
            document.getElementById('umidadeAr').innerText = '--%';
            document.getElementById('temperatura').innerText = '--¬∞C';
            document.getElementById('ultimaAtualizacao').innerText = 'Sem leituras';
            document.getElementById('statusDispositivo').innerHTML = '‚ö™ Sem dados';
          }
        })
        .catch(err => console.error('Erro ao carregar dados dos sensores:', err));
    }

    

    function carregarHistorico(dispositivoId) {
      fetch(`/esp32/sensores/${dispositivoId}/historico?horas=24`, { credentials: 'include' })
        .then(res => {
          if (res.status === 401) {
            alert('Sess√£o expirada. Fa√ßa login novamente.');
            window.location.href = '/login.html';
            return;
          }
          return res.json();
        })
        .then(data => {
          if (!data) return;
          if (data.success && data.historico.length > 0) {
            const labels = [];
            const valores = [];
            data.historico.forEach(leitura => {
              const dt = new Date(leitura.criado_em);
              const hora = dt.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
              labels.push(hora);
              valores.push(leitura.umidade_solo_perc || 0);
            });
            chart.data.labels = labels;
            chart.data.datasets[0].data = valores;
            chart.update();
          } else {
            chart.data.labels = ['Sem dados'];
            chart.data.datasets[0].data = [0];
            chart.update();
          }
        })
        .catch(err => console.error('Erro ao carregar hist√≥rico:', err));
    }

    function carregarProjecaoIrrigacao(dispositivoId) {
      fetch(`/esp32/projecao/${dispositivoId}`, { credentials: 'include' })
        .then(res => {
          if (res.status === 401) {
            alert('Sess√£o expirada. Fa√ßa login novamente.');
            window.location.href = '/login.html';
            return;
          }
          return res.json();
        })
        .then(data => {
          if (!data) return;
          if (data.success && data.projecao) {
            const p = data.projecao;
            if (p.data_proxima_irrigacao) {
              const dataIrrigacao = new Date(p.data_proxima_irrigacao);
              const dataFormatada = dataIrrigacao.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
              document.getElementById('proximaIrrigacao').innerText = dataFormatada;

              if (p.dias_restantes !== null) {
                if (p.dias_restantes > 0) document.getElementById('diasRestantes').innerText = `Em ${p.dias_restantes} dia(s)`;
                else if (p.dias_restantes === 0) document.getElementById('diasRestantes').innerText = 'Hoje';
                else document.getElementById('diasRestantes').innerText = `Atrasado h√° ${Math.abs(p.dias_restantes)} dia(s)`;
              }
            } else {
              document.getElementById('proximaIrrigacao').innerText = '---';
              document.getElementById('diasRestantes').innerText = 'Sem dados de irriga√ß√£o';
            }

            if (p.quantidade_agua_litros) {
              document.getElementById('quantidadeAgua').innerText = `${p.quantidade_agua_litros.toFixed(0)} L`;
              document.getElementById('areaInfo').innerText = `√Årea: ${p.area_cultivada_m2} m¬≤`;
            } else {
              document.getElementById('quantidadeAgua').innerText = '--- L';
              document.getElementById('areaInfo').innerText = '√Årea: ---';
            }
          } else {
            document.getElementById('proximaIrrigacao').innerText = '---';
            document.getElementById('diasRestantes').innerText = 'Sem dados';
            document.getElementById('quantidadeAgua').innerText = '--- L';
            document.getElementById('areaInfo').innerText = '√Årea: ---';
          }
        })
        .catch(err => console.error('Erro ao carregar proje√ß√£o de irriga√ß√£o:', err));
    }

    function logout() {
      if (window.intervalAtualizacao) clearInterval(window.intervalAtualizacao);
      if (logoutTimer) clearTimeout(logoutTimer); // <- evita timeout disparar no meio do logout

      fetch('/logout', {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' }
      })
      .then(() => { localStorage.removeItem('usuarioLogado'); window.location.href = '/login.html'; })
      .catch(() => { localStorage.removeItem('usuarioLogado'); window.location.href = '/login.html'; });
    }

    // Inicializar ao carregar a p√°gina
    inicializar();

     let logoutTimer;
  const TEMPO_MAXIMO_INATIVIDADE = 2 * 60 * 1000; // 2 minutos



  function logoutAutomatico() {
    // evita alert duplicado se j√° estiver saindo
    if (window.__expirando__) return;
    window.__expirando__ = true;
    alert('Sess√£o expirada por inatividade.');
    // chama seu logout padr√£o (encerra sess√£o no back e redireciona)
    logout();
  }

  function reiniciarTimer() {
    clearTimeout(logoutTimer);
    logoutTimer = setTimeout(logoutAutomatico, TEMPO_MAXIMO_INATIVIDADE);
  }

  // come√ßa o timer s√≥ depois que a p√°gina terminou de carregar e seu inicializar() j√° rodou
  window.addEventListener('load', reiniciarTimer);

  // eventos que contam como atividade
  ['mousemove','keypress','scroll','click','touchstart'].forEach(evt =>
    document.addEventListener(evt, reiniciarTimer, { passive: true })
  );

  // se a aba voltar a ficar vis√≠vel, reinicia
  document.addEventListener('visibilitychange', () => {
    if (!document.hidden) reiniciarTimer();
  });


// ========= Helpers Modal Dispositivo =========
function showAlertDisp(msg, type='success') {
  const el = document.getElementById('alertDisp');
  el.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
  setTimeout(() => { el.innerHTML=''; }, 5000);
}

// Abre modal em modo criacao/edicao
async function abrirModalDispositivo(modo, dados = null) {
  const modal = document.getElementById('modalDispositivo');
  const titulo = document.getElementById('tituloModalDisp');
  const btnExcluir = document.getElementById('btnExcluirDisp');
  const form = document.getElementById('formDispositivo');

  form.reset();
  document.getElementById('dispId').value = '';

  // garante que o select tenha op√ß√µes
  const selCultura = document.getElementById('dispCultura');
  if (!selCultura.options.length || selCultura.options.length === 1) {
    await carregarCulturas();
  }

  if (modo === 'edit' && dados) {
    // Modo edi√ß√£o
    titulo.textContent = '‚úèÔ∏è Editar dispositivo';
    document.getElementById('dispId').value = dados.id;

    // Serial: somente leitura e esmaecido
    const serialEl = document.getElementById('dispSerial');
    serialEl.value = dados.serialnumber || '';
    serialEl.readOnly = true;
    serialEl.style.opacity = '0.65';
    serialEl.title = 'O serial n√£o pode ser alterado.';

    // Demais campos
    document.getElementById('dispCultura').value = dados.fk_culturas ? String(dados.fk_culturas) : '';
    document.getElementById('dispCEP').value     = dados.CEP || '';
    document.getElementById('dispRua').value     = dados.rua || '';
    document.getElementById('dispNumero').value  = dados.numero || '';
    document.getElementById('dispBairro').value  = dados.bairro || '';
    document.getElementById('dispCidade').value  = dados.cidade || '';
    document.getElementById('dispEstado').value  = (dados.estado || '').slice(0,2);

    // Mostrar bot√£o excluir no modo edi√ß√£o
    btnExcluir.style.display = 'block';

  } else {
    // Modo adicionar
    titulo.textContent = '‚ûï Adicionar dispositivo';
    document.getElementById('dispId').value = '';

    // Serial: habilitado e normal
    const serialEl = document.getElementById('dispSerial');
    serialEl.readOnly = false;
    serialEl.style.opacity = '';
    serialEl.title = '';
    serialEl.value = '';

    // Demais campos limpos
    document.getElementById('dispCultura').value = '';
    document.getElementById('dispCEP').value     = '';
    document.getElementById('dispRua').value     = '';
    document.getElementById('dispNumero').value  = '';
    document.getElementById('dispBairro').value  = '';
    document.getElementById('dispCidade').value  = '';
    document.getElementById('dispEstado').value  = '';

    // Esconde bot√£o excluir
    btnExcluir.style.display = 'none';
  }

  // >>> importante: exibir o modal e FECHAR a fun√ß√£o
  modal.style.display = 'block';
}


// Fecha modal
(function wireModalDisp() {
  const modal = document.getElementById('modalDispositivo');
  document.getElementById('fecharModalDisp').addEventListener('click', () => {
    modal.style.display = 'none';
  });
  window.addEventListener('click', (e) => {
    if (e.target === modal) modal.style.display = 'none';
  });
})();

// CEP ‚Üí auto-preenche (ViaCEP)
async function preencherPorCEP() {
  const cep = document.getElementById('dispCEP').value.replace(/\D/g,'');
  if (cep.length !== 8) return;
  try {
    const r = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
    const j = await r.json();
    if (j.erro) { showAlertDisp('CEP n√£o encontrado', 'error'); return; }
    document.getElementById('dispRua').value = j.logradouro || '';
    document.getElementById('dispBairro').value = j.bairro || '';
    document.getElementById('dispCidade').value = j.localidade || '';
    document.getElementById('dispEstado').value = (j.uf || '').slice(0,2);
  } catch(e) {
    console.error(e);
    showAlertDisp('Falha ao buscar CEP', 'error');
  }
}
document.getElementById('dispCEP').addEventListener('blur', preencherPorCEP);

// Monta string do endere√ßo para geocode
function montarEndereco() {
  const rua = document.getElementById('dispRua').value.trim();
  const numero = document.getElementById('dispNumero').value.trim();
  const bairro = document.getElementById('dispBairro').value.trim();
  const cidade = document.getElementById('dispCidade').value.trim();
  const estado = document.getElementById('dispEstado').value.trim();
  const cep = document.getElementById('dispCEP').value.trim();
  const partes = [rua, numero, bairro, cidade, estado, 'Brasil', cep].filter(Boolean);
  return partes.join(', ');
}

// Chama geocode no backend
async function geocodeEndereco() {
  const q = montarEndereco();
  const r = await fetch(`/api/geocode?q=${encodeURIComponent(q)}`, { credentials:'include' });
  const j = await r.json();
  if (j.success && j.found) return { lat: j.lat, lon: j.lon };
  return { lat: null, lon: null };
}

// Submit do formul√°rio (criar/editar)
// Submit do formul√°rio (criar/editar)
document.getElementById('formDispositivo').addEventListener('submit', async (e) => {
  e.preventDefault();
  const id = document.getElementById('dispId').value;

  // Normaliza√ß√µes
  const cepDigits = document.getElementById('dispCEP').value.trim().replace(/\D/g, '');
  const numeroRaw = document.getElementById('dispNumero').value.trim();
  const numeroVal = numeroRaw === '' ? null : numeroRaw;

  const payload = {
    fk_culturas: Number(document.getElementById('dispCultura').value) || null,
    CEP:    cepDigits,
    rua:    document.getElementById('dispRua').value.trim(),
    numero: numeroVal,
    bairro: document.getElementById('dispBairro').value.trim(),
    cidade: document.getElementById('dispCidade').value.trim(),
    estado: document.getElementById('dispEstado').value.trim().toUpperCase()
  };

  // POST inclui serial, PUT n√£o (e for√ßa remo√ß√£o se sobrar por engano)
  if (!id) {
    payload.serialnumber = document.getElementById('dispSerial').value.trim();
  } else {
    delete payload.serialnumber;
  }

  // Geocode obrigat√≥rio: se n√£o achar, n√£o envia
  try {
    const g = await geocodeEndereco();
    const lat = Number(g.lat), lon = Number(g.lon);
    if (!Number.isFinite(lat) || !Number.isFinite(lon)) {
      showAlertDisp('N√£o foi poss√≠vel localizar o endere√ßo (lat/lon). Verifique CEP/rua/bairro/cidade/UF.', 'error');
      return;
    }
    payload.latitude  = lat;
    payload.longitude = lon;
  } catch (_) {
    showAlertDisp('Falha no geocodificador. Tente novamente.', 'error');
    return;
  }

  try {
    const url  = id ? `/me/dispositivos/${id}` : '/me/dispositivos/vincular';
    const opts = {
      method: id ? 'PUT' : 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify(payload)
    };

    const resp = await fetch(url, opts);
    let out = {};
    try { out = await resp.json(); } catch {}

    if (resp.ok && out.success) {
      showAlertDisp('Salvo com sucesso!', 'success');
      setTimeout(() => {
        document.getElementById('modalDispositivo').style.display = 'none';
        carregarDispositivos();
      }, 500);
    } else {
      const msg = (out && (out.message || out.error)) || `${resp.status} ${resp.statusText}` || 'Erro ao salvar';
      showAlertDisp(msg, 'error');
      console.error('Salvar dispositivo - erro:', { status: resp.status, out, payload });
    }
  } catch (err) {
    console.error(err);
    showAlertDisp('Erro ao salvar (falha de rede).', 'error');
  }
});

// Wire dos bot√µes "Adicionar" e "Editar"
document.getElementById('btnAddDisp').addEventListener('click', () => abrirModalDispositivo('add'));
document.getElementById('btnEditarDisp').addEventListener('click', () => {
  if (!dispositivoAtual) { alert('Selecione um dispositivo primeiro.'); return; }
  abrirModalDispositivo('edit', dispositivoAtual);
});

// Fun√ß√£o de exclus√£o
async function excluirDispositivo() {
  const id = document.getElementById('dispId').value;
  if (!id) return alert('Nenhum dispositivo selecionado.');
  const confirmar = confirm('Tem certeza que deseja remover este dispositivo? Esta a√ß√£o n√£o pode ser desfeita.');
  if (!confirmar) return;

  try {
    const resp = await fetch(`/me/dispositivos/${id}`, {
      method: 'DELETE',
      credentials: 'include'
    });
    const data = await resp.json();
    if (resp.ok && data.success) {
      alert('Dispositivo removido com sucesso!');
      document.getElementById('modalDispositivo').style.display = 'none';
      carregarDispositivos();
    } else {
      alert(data.message || 'Erro ao remover dispositivo.');
    }
  } catch (err) {
    console.error(err);
    alert('Erro ao excluir dispositivo.');
  }
}

// Associar ao bot√£o
document.getElementById('btnExcluirDisp').addEventListener('click', excluirDispositivo);

// Quando selecionar dispositivo na lista, guarda o objeto completo para edi√ß√£o
function selecionarDispositivo(dispositivo) {
  dispositivoAtual = dispositivo;
  document.querySelectorAll('.dispositivo-item').forEach(item => {
    item.classList.remove('selecionado');
    if (item.dataset.dispositivoId == dispositivo.id) item.classList.add('selecionado');
  });

  document.getElementById('nomeDispositivo').innerText = dispositivo.nome_cultura || 'Sem cultura definida';
  document.getElementById('serialDispositivo').innerText = `Serial: ${dispositivo.serialnumber}`;
  document.getElementById('culturaNome').innerText = dispositivo.nome_cultura || '---';
  document.getElementById('aguaNecessaria').innerText = dispositivo.agua_necessaria ? `${dispositivo.agua_necessaria} L/m¬≤` : '---';
  document.getElementById('frequenciaIrrigacao').innerText = dispositivo.frequencia_irrigacao_dias ? `${dispositivo.frequencia_irrigacao_dias} dias` : '---';

  carregarDadosSensores(dispositivo.id);
  carregarHistorico(dispositivo.id);
  carregarProjecaoIrrigacao(dispositivo.id);

  if (window.intervalAtualizacao) clearInterval(window.intervalAtualizacao);
  window.intervalAtualizacao = setInterval(() => {
    carregarDadosSensores(dispositivo.id);
    carregarProjecaoIrrigacao(dispositivo.id);
  }, 30000);
}



// Wire dos bot√µes "Adicionar" e "Editar"
document.getElementById('btnAddDisp').addEventListener('click', ()=> abrirModalDispositivo('add'));
document.getElementById('btnEditarDisp').addEventListener('click', ()=>{
  if (!dispositivoAtual) { alert('Selecione um dispositivo primeiro.'); return; }
  abrirModalDispositivo('edit', dispositivoAtual);
});


// Fun√ß√£o de exclus√£o
async function excluirDispositivo() {
  const id = document.getElementById('dispId').value;
  if (!id) return alert('Nenhum dispositivo selecionado.');
  const confirmar = confirm('Tem certeza que deseja remover este dispositivo? Esta a√ß√£o n√£o pode ser desfeita.');
  if (!confirmar) return;

  try {
    const resp = await fetch(`/me/dispositivos/${id}`, {
      method: 'DELETE',
      credentials: 'include'
    });
    const data = await resp.json();
    if (resp.ok && data.success) {
      alert('Dispositivo removido com sucesso!');
      document.getElementById('modalDispositivo').style.display = 'none';
      carregarDispositivos();
    } else {
      alert(data.message || 'Erro ao remover dispositivo.');
    }
  } catch (err) {
    console.error(err);
    alert('Erro ao excluir dispositivo.');
  }
}

// Associar ao bot√£o
document.getElementById('btnExcluirDisp').addEventListener('click', excluirDispositivo);




  </script>
</body>
</html>

