<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Login - SmartFarm</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Se preferir usar o style.css geral, troque o arquivo abaixo -->
  <link rel="stylesheet" href="login.css" />
  <style>
    .hidden{display:none}

    /* ===== melhorias pontuais para o login ===== */
    .brand{
      display:flex; align-items:center; gap:12px; margin-bottom:10px;
    }
    .brand-logo{
      width:40px; height:40px; object-fit:contain; border-radius:8px;
      background:#0a1f1c; display:block;
    }
    .brand-title{
      margin:0; font-size:26px; line-height:1.1;
    }
    .brand-sub{
      margin:0; margin-top:2px; font-size:13px; opacity:.8;
    }
    .input-wrap{
      position:relative;
    }
    .toggle-pass{
      position:absolute; right:8px; top:50%; transform:translateY(-50%);
      background:transparent; border:0; cursor:pointer; padding:6px;
      border-radius:8px; line-height:0; color:#9fffe9;
    }
    .toggle-pass:hover{ background:rgba(0,255,195,.08) }
    .toggle-pass svg{ width:18px; height:18px }
  </style>
</head>
<body>
  <div class="shell">
    <!-- LOGIN -->
    <div id="loginBox" class="section login-section">
      <div class="brand">

        <img class="brand-logo" src="logosmart.png" alt="SmartFarm">
        <div>
          <h1 class="brand-title">SmartFarm</h1>
          <p class="brand-sub">Login do Usuário</p>
        </div>
      </div>

      <input type="text" id="user" placeholder="Login" autocomplete="username" />

      <div class="input-wrap">
        <input type="password" id="pass" placeholder="Senha" autocomplete="current-password" />
        <button type="button" id="btnTogglePass" class="toggle-pass" aria-label="Mostrar senha" title="Mostrar/Ocultar senha">
          <!-- ícone olho -->
          <div class="input-wrapper">
  <input type="password" id="senha" placeholder="Senha" />
          <svg id="iconEye" xmlns="http://www.w3.org/2000/svg" 
              viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M12 5c-5 0-9 3.5-10 7 1 3.5 5 7 10 7s9-3.5 10-7c-1-3.5-5-7-10-7zm0 12a5 5 0 1 1 0-10 5 5 0 0 1 0 10zm0-2.5A2.5 2.5 0 1 0 12 8a2.5 2.5 0 0 0 0 5.5z"/>
          </svg>
</div>
        </button>
      </div>

      <button onclick="login()">Entrar</button>
      <span id="mensagem" role="alert"></span>
    </div>

    <!-- PAINEL (aparece após login) -->
    <div id="painelUsuario" class="section hidden">
      <div class="painel-head">
        <div>
          <h2>Painel Admin</h2>
          <p id="mensagemLogin"></p>
        </div>
        <div style="min-width:220px">
          <button onclick="logout()">Sair</button>
        </div>
      </div>
      <div id="adminArea" class="admin-grid"></div>
    </div>
  </div>

<script>
/* =======================
   Verificar sessão
======================= */
async function verificarSessaoExistente() {
  try {
    const response = await fetch('/session', { credentials: 'include' });
    const data = await response.json();
    if (data.authenticated) window.location.href = 'dash.html';
  } catch (error) {
    console.log('Não autenticado, mostrar login');
  }
}
verificarSessaoExistente();

/* =======================
   Mostrar/Ocultar Senha
======================= */
(function(){
  const input = document.getElementById('pass');
  const btn   = document.getElementById('btnTogglePass');
  const icon  = document.getElementById('iconEye');

  if (!btn || !input) return;

  btn.addEventListener('click', () => {
    const isPwd = input.type === 'password';
    input.type = isPwd ? 'text' : 'password';
    btn.setAttribute('aria-label', isPwd ? 'Ocultar senha' : 'Mostrar senha');

    // alternar ícone (olho aberto/fechado)
    icon.innerHTML = isPwd
      ? '<path d="M2 12c1.2 3.7 5.3 7 10 7 2.1 0 4-.6 5.7-1.7l1.7 1.7 1.4-1.4-18-18-1.4 1.4 3.1 3.1C3.2 6.9 1.9 9.2 2 12zm8.3-6 2.2 2.2c.5.2 1 .5 1.4.9a4 4 0 0 1-5.6 5.6c-.4-.4-.7-.9-.9-1.4L5.2 10C6.2 7.9 8.1 6.5 10.3 6zM12 19c-5 0-9-3.5-10-7 .4-1.5 1.3-2.9 2.5-4l2.3 2.3a6 6 0 0 0 7 7l2.2 2.2c-1.2.3-2.5.5-4 .5z"/>'
      : '<path d="M12 5c-5 0-9 3.5-10 7 1 3.5 5 7 10 7s9-3.5 10-7c-1-3.5-5-7-10-7zm0 12a5 5 0 1 1 0-10 5 5 0 0 1 0 10z"/><circle cx="12" cy="12" r="2.5"/>';
  });
})();

/* =======================
   Estado local
======================= */
let alvo = { id: null, loginOriginal: "" };

window.onload = () => {
  const dados = localStorage.getItem('usuarioLogado');
  if (dados) {
    const user = JSON.parse(dados);
    document.getElementById('loginBox').classList.add('hidden');
    document.getElementById('painelUsuario').classList.remove('hidden');
    document.getElementById('mensagemLogin').innerText = `Bem-vindo(a), ${user.nome}!`;

    if (user.isAdmin && !document.getElementById('adminCardsBuilt')) {
      montarPainelAdmin();
    } else {
      fetch(`/usuarios?login=${encodeURIComponent(user.usuario)}`)
        .then(res => res.json())
        .then(resp => {
          const lista = Array.isArray(resp) ? resp : (resp.usuarios || []);
          if (lista.length > 0) {
            const isAdmin = lista[0].usuario === 'admin';
            if (isAdmin && !document.getElementById('adminCardsBuilt')) montarPainelAdmin();
          }
        })
        .catch(()=>{});
    }
  }
};

/* ------------ Auth ------------ */
function login() {
  const usuario = document.getElementById('user').value.trim();
  const senha   = document.getElementById('pass').value;
  const msgEl   = document.getElementById('mensagem');

  if (!usuario || !senha){
    msgEl.textContent = 'Informe login e senha.'; return;
  }

  fetch('/login', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    credentials: 'include',
    body: JSON.stringify({ usuario, senha })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success){
      localStorage.setItem('usuarioLogado', JSON.stringify(data));
      if (data.isAdmin) { document.getElementById('loginBox').classList.add('hidden'); document.getElementById('painelUsuario').classList.remove('hidden'); }
      else window.location.href = 'dash.html';
    } else {
      msgEl.textContent = data.message || 'Usuário ou senha inválidos!';
    }
  })
  .catch(()=> msgEl.textContent = 'Sem conexão com o servidor.');
}

function logout(){
  try{
    const u = JSON.parse(localStorage.getItem('usuarioLogado') || '{}');
    fetch('/logout', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({usuario: u.usuario})});
  }catch{}
  localStorage.removeItem('usuarioLogado');
  location.reload();
}

/* ------------ Cadastro ------------ */
function criarUsuario(){
  const nome    = document.getElementById('nomeUsuario').value.trim();
  const email   = document.getElementById('emailUsuario').value.trim();
  const usuario = document.getElementById('novoUsuario').value.trim();
  const senha   = document.getElementById('novaSenha').value.trim();

  fetch('/usuarios',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ nome, email, usuario, senha })
  })
  .then(res => res.json())
  .then(data => {
    document.getElementById('mensagem').innerText = data.message || (data.success ? 'Criado!' : 'Erro.');
    filtrarUsuarios();
  })
  .catch(()=> document.getElementById('mensagem').innerText = 'Erro ao criar usuário.');
}

/* ------------ Gerenciar Dispositivos (NOVO) ------------ */
function carregarDispositivos() {
  const lista = document.getElementById('listaDispositivos');
  lista.innerHTML = '<p style="opacity: 0.7; font-size: 12px;">Carregando dispositivos...</p>';

  // Buscar dispositivos ESP32 com informações de usuário
  fetch('/esp32/dispositivos/todos')
    .then(res => res.json())
    .then(data => {
      if (data.success && data.dispositivos && data.dispositivos.length > 0) {
        exibirDispositivos(data.dispositivos);
      } else {
        // Se a rota /esp32/dispositivos/todos não existir, vamos buscar de outra forma
        // Primeiro, buscar todos os usuários
        return fetch('/usuarios')
          .then(res => res.json())
          .then(usuarios => {
            const promessas = usuarios.map(usuario => 
              fetch(`/esp32/dispositivos/${usuario.id}`)
                .then(res => res.json())
                .then(data => {
                  if (data.success && data.dispositivos) {
                    return data.dispositivos.map(disp => ({
                      ...disp,
                      usuario_nome: usuario.nome,
                      usuario_login: usuario.usuario
                    }));
                  }
                  return [];
                })
                .catch(() => [])
            );
            
            return Promise.all(promessas);
          })
          .then(resultados => {
            const todosDispositivos = resultados.flat();
            if (todosDispositivos.length > 0) {
              exibirDispositivos(todosDispositivos);
            } else {
              lista.innerHTML = '<p style="opacity: 0.7; font-size: 12px;">Nenhum dispositivo encontrado no sistema.</p>';
            }
          });
      }
    })
    .catch(err => {
      console.error('Erro ao carregar dispositivos:', err);
      lista.innerHTML = '<p style="color: #ff4444; font-size: 12px;">Erro ao carregar dispositivos.</p>';
    });
}

function exibirDispositivos(dispositivos) {
  const lista = document.getElementById('listaDispositivos');
  lista.innerHTML = '';
  
  if (!dispositivos || dispositivos.length === 0) {
    lista.innerHTML = '<p style="opacity: 0.7; font-size: 12px;">Nenhum dispositivo encontrado.</p>';
    return;
  }

  dispositivos.forEach(disp => {
    const item = document.createElement('div');
    item.style.cssText = 'margin-bottom: 10px; padding: 8px; border: 1px solid #444; border-radius: 4px; background-color: #111;';
    
    const usuarioInfo = disp.usuario_nome ? 
      `<strong>${disp.usuario_nome}</strong> (${disp.usuario_login || 'ID: ' + disp.fk_usuarios})` : 
      `<span style="color: #ff8888;">Não vinculado</span>`;
    
    const culturaInfo = disp.nome_cultura ? 
      `<span style="color: #88ff88;">${disp.nome_cultura}</span>` : 
      `<span style="opacity: 0.6;">Sem cultura</span>`;

    item.innerHTML = `
      <div style="font-size: 12px;">
        <div><strong>Serial:</strong> ${disp.serialnumber}</div>
        <div><strong>Usuário:</strong> ${usuarioInfo}</div>
        <div><strong>Cultura:</strong> ${culturaInfo}</div>
        <div style="opacity: 0.6; margin-top: 4px;">ID: ${disp.id}</div>
      </div>
    `;
    
    lista.appendChild(item);
  });
}

function carregarCulturas() {
  fetch('/culturas')
    .then(res => res.json())
    .then(data => {
      const select = document.getElementById('culturaVinculo');
      if (data && Array.isArray(data)) {
        data.forEach(cultura => {
          const option = document.createElement('option');
          option.value = cultura.id;
          option.textContent = cultura.cultura;
          select.appendChild(option);
        });
      }
    })
    .catch(err => {
      console.error('Erro ao carregar culturas:', err);
      // Se não conseguir carregar culturas, adicionar algumas opções padrão
      const select = document.getElementById('culturaVinculo');
      const culturasPadrao = ['Alface', 'Tomate', 'Cenoura', 'Milho', 'Soja'];
      culturasPadrao.forEach((nome, index) => {
        const option = document.createElement('option');
        option.value = index + 1;
        option.textContent = nome;
        select.appendChild(option);
      });
    });
}

function vincularDispositivo() {
  const serial = document.getElementById('serialVinculo').value.trim();
  const usuarioLogin = document.getElementById('usuarioVinculo').value.trim();
  const culturaId = document.getElementById('culturaVinculo').value;
  const msg = document.getElementById('mensagemVinculo');

  if (!serial || !usuarioLogin) {
    msg.innerText = 'Por favor, preencha o serial do dispositivo e o login do usuário.';
    msg.style.color = '#ff4444';
    return;
  }

  // Primeiro, verificar se o usuário existe
  fetch(`/usuarios?login=${encodeURIComponent(usuarioLogin)}`)
    .then(res => res.json())
    .then(usuarios => {
      if (!usuarios || usuarios.length === 0) {
        msg.innerText = 'Usuário não encontrado.';
        msg.style.color = '#ff4444';
        return;
      }

      const usuario = usuarios[0];
      
      // Agora, verificar se o dispositivo existe na tabela esp32_dispositivos
      // Se não existir, criar primeiro
      const dadosVinculo = {
        serialnumber: serial,
        fk_usuarios: usuario.id,
        fk_culturas: culturaId || null
      };

      // Tentar inserir/atualizar o dispositivo
      fetch('/esp32/dispositivos', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(dadosVinculo)
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          msg.innerText = `Dispositivo ${serial} vinculado com sucesso ao usuário ${usuarioLogin}!`;
          msg.style.color = '#44ff44';
          
          // Limpar campos
          document.getElementById('serialVinculo').value = '';
          document.getElementById('usuarioVinculo').value = '';
          document.getElementById('culturaVinculo').value = '';
          
          // Atualizar lista de dispositivos
          carregarDispositivos();
        } else {
          msg.innerText = data.message || 'Erro ao vincular dispositivo.';
          msg.style.color = '#ff4444';
        }
      })
      .catch(err => {
        console.error('Erro ao vincular dispositivo:', err);
        msg.innerText = 'Erro ao conectar com o servidor.';
        msg.style.color = '#ff4444';
      });
    })
    .catch(err => {
      console.error('Erro ao buscar usuário:', err);
      msg.innerText = 'Erro ao verificar usuário.';
      msg.style.color = '#ff4444';
    });
}

/* ------------ Listagem / Alteração / Exclusão ------------ */
function filtrarUsuarios(){
  const q = (document.getElementById('usuarioBusca')?.value || '').trim();
  fetch('/usuarios/busca?q=' + encodeURIComponent(q))
    .then(r=>r.json())
    .then(data => { if(data.success) exibirUsuarios(data.usuarios); })
    .catch(()=>{});
}

function exibirUsuarios(lista){
  const c = document.getElementById('listaUsuarios');
  c.innerHTML = '';
  (lista || []).forEach(u=>{
    const label = (u.usuario && u.usuario.trim()) ? u.usuario : '(sem login)';
    const row = document.createElement('div');
    row.className = 'usuario-item';
    row.innerHTML = `
      <span><strong>${label}</strong> <small>(id: ${u.id})</small></span>
      <button type="button">Editar</button>
    `;
    row.querySelector('button').onclick = () => preencherForm(u);
    c.appendChild(row);
  });
}

function preencherForm(u){
  alvo.id = u.id;                          // sempre teremos ID
  alvo.loginOriginal = (u.usuario || '');  // pode estar vazio
  document.getElementById('formAlteracao').style.display = 'block';
  document.getElementById('novoLogin').value = u.usuario || '';
  document.getElementById('novoNome').value  = u.nome    || '';
  document.getElementById('novoEmail').value = u.email   || '';
  document.getElementById('novaSenhaAlterar').value = '';
  document.getElementById('msgAlteracao').innerText = '';
}

async function atualizarUsuario(){
  const msg = (t)=> document.getElementById('msgAlteracao').innerText = t;
  if(!alvo.id){ msg('Selecione um usuário na lista.'); return; }

  // campos do form
  const novoLogin = document.getElementById('novoLogin').value.trim();
  const novoNome  = document.getElementById('novoNome').value.trim();
  const novoEmail = document.getElementById('novoEmail').value.trim();
  const novaSenha = document.getElementById('novaSenhaAlterar').value;

  // Para registros "vazios", exigimos todos os campos para corrigir de uma vez
  if(!(novoLogin && novoNome && novoEmail && novaSenha)){
    msg('Preencha login, nome, e-mail e uma nova senha para atualizar este usuário.');
    return;
  }

  try{
    // Preferimos atualizar por ID (rota: PUT /usuarios/:id)
    const url = '/usuarios/' + encodeURIComponent(alvo.id);

    const res = await fetch(url, {
      method: 'PUT',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ usuario: novoLogin, senha: novaSenha, nome: novoNome, email: novoEmail })
    }).then(r=>r.json());

    if(res.success){
      msg('Usuário atualizado com sucesso!');
      alvo.loginOriginal = novoLogin; // caso tenha sido definido/corrigido
      filtrarUsuarios();
    }else{
      msg(res.message || res.error || 'Erro ao atualizar.');
    }
  }catch(e){
    console.error(e);
    msg('Erro ao atualizar (ver console).');
  }
}

async function excluirUsuarioPorLogin(){
  const msg = (t)=> document.getElementById('msgAlteracao').innerText = t;
  if(!alvo.id){ msg('Selecione um usuário na lista.'); return; }
  if(!confirm('Excluir este usuário? Essa ação é irreversível.')) return;

  try{
    // Agora deletamos DIRETO por ID (independente do login estar vazio)
    const res = await fetch('/usuarios/' + encodeURIComponent(alvo.id), { method: 'DELETE' })
      .then(r=>r.json());

    if(res.success){
      msg('Usuário excluído com sucesso!');
      alvo = { id:null, loginOriginal:'' };
      document.getElementById('formAlteracao').style.display = 'none';
      filtrarUsuarios();
    }else{
      msg(res.message || res.error || 'Erro ao excluir.');
    }
  }catch(e){
    console.error(e);
    msg('Erro ao excluir (ver console).');
  }
}

/* ------------ Logs / Online ------------ */
function mostrarUsuariosOnline(){
  fetch('/online')
    .then(res=>res.json())
    .then(data=> document.getElementById('usuariosOnline').innerText = `Usuários online: ${data.online}`)
    .catch(()=> document.getElementById('usuariosOnline').innerText = 'Usuários online: erro');
}

function carregarLogs(){
  const u = (document.getElementById('filtroUsuarioLog')?.value || '').trim();
  const s = (document.getElementById('filtroSucesso')?.value || '');
  const qs = new URLSearchParams();
  if (u) qs.set('usuario', u);
  if (s!=='') qs.set('sucesso', s);
  qs.set('limit', 50);

  fetch('/admin/logins?'+qs.toString(), { headers: { 'X-Admin':'1' }})
    .then(res=>res.json())
    .then(data=>{
      const logsDiv = document.getElementById('logsArea');
      logsDiv.innerHTML = '';
      if (!data.success){ logsDiv.innerHTML = '<div style="color:#ff8a8a;">Não autorizado ou erro.</div>'; return; }
      (data.logs||[]).forEach(log=>{
        const d = new Date(log.criado_em);
        const row = document.createElement('div');
        row.className = 'log-item';
        row.innerHTML = `<strong>${log.usuario || '(desconhecido)'}</strong> — ${log.ip} — ${d.toLocaleString()} — ${log.sucesso ? '✔' : '✖'}<br><small>${log.user_agent || ''}</small>`;
        logsDiv.appendChild(row);
      });
      if (!(data.logs||[]).length) logsDiv.innerHTML = '<div style="opacity:.8;">Sem logs ainda.</div>';
    })
    .catch(()=> document.getElementById('logsArea').innerHTML = '<div style="color:#ff8a8a;">Erro ao carregar logs.</div>');
}
</script>
</body>
</html>


