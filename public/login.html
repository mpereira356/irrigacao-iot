<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Login - SmartFarm</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- deixe o arquivo login.css na pasta /public -->
  <link rel="stylesheet" href="login.css" />
  <style>.hidden{display:none}</style>
</head>
<body>
  <div class="shell">
    <!-- LOGIN -->
    <div id="loginBox" class="section login-section">
      <h1>SmartFarm</h1>
      <p>Login do Usuário</p>
      <input type="text" id="user" placeholder="Login" />
      <input type="password" id="pass" placeholder="Senha" style="text-indent:10px" />
      <button onclick="login()">Entrar</button>
    </div>

    <!-- PAINEL (aparece após login) -->
    <div id="painelUsuario" class="section hidden">
      <div class="painel-head">
        <div>
          <h2>Painel Admin</h2>
          <p id="mensagemLogin"></p>
        </div>
        <div style="min-width:220px">
          <button onclick="logout()">Sair</button>
        </div>
      </div>
      <div id="adminArea" class="admin-grid"></div>
    </div>
  </div>

<script>
/* =======================
   CONFIG / DEMO MODE
   =======================

   Para testar a área admin sem servidor:
   -> descomente a linha abaixo, recarregue a página

// localStorage.setItem('usuarioLogado', JSON.stringify({usuario:'admin', nome:'Admin', isAdmin:true}));

*/

let alvo = { id: null, loginOriginal: "" }; // estado do usuário selecionado

window.onload = () => {
  const dados = localStorage.getItem('usuarioLogado');
  if (dados) {
    const user = JSON.parse(dados);
    document.getElementById('loginBox').classList.add('hidden');
    document.getElementById('painelUsuario').classList.remove('hidden');
    document.getElementById('mensagemLogin').innerText = `Bem-vindo(a), ${user.nome}!`;

    if (user.isAdmin && !document.getElementById('adminCardsBuilt')) {
      montarPainelAdmin();
    } else {
      // Caso queira checar no backend se é admin
      fetch(`/usuarios?login=${encodeURIComponent(user.usuario)}`)
        .then(res => res.json())
        .then(resp => {
          const lista = Array.isArray(resp) ? resp : (resp.usuarios || []);
          if (lista.length > 0) {
            const isAdmin = lista[0].usuario === 'admin';
            if (isAdmin && !document.getElementById('adminCardsBuilt')) montarPainelAdmin();
          }
        })
        .catch(()=>{});
    }
  }
};

/* ------------ UI helpers ------------ */
function sectionCard(html){
  const wrap = document.createElement('div');
  wrap.className = 'card';
  wrap.innerHTML = html;
  return wrap;
}

function montarPainelAdmin() {
  const grid = document.getElementById('adminArea');
  grid.id = 'adminCardsBuilt';

  // CARD 1: Cadastro
  grid.appendChild(sectionCard(`
    <h3>Cadastro</h3>
    <p id="usuariosOnline" class="help">Usuários online: carregando...</p>
    <input type="text" id="nomeUsuario" placeholder="Nome do novo usuário">
    <input type="email" id="emailUsuario" placeholder="E-mail do novo usuário">
    <input type="text" id="novoUsuario" placeholder="Login do novo usuário">
    <input type="password" id="novaSenha" placeholder="Senha">
    <button onclick="criarUsuario()">Criar novo usuário</button>
    <p id="mensagem" class="help"></p>
  `));

  // CARD 2: Alterar/Excluir
  grid.appendChild(sectionCard(`
    <h3>Alterar Usuário</h3>
    <p class="help">* Digite para filtrar; deixe vazio para listar todos.</p>
    <input type="text" id="usuarioBusca" placeholder="Login do usuário a alterar" oninput="filtrarUsuarios()" autocomplete="off">
    <div id="listaUsuarios"></div>
    <div id="formAlteracao" style="margin-top: 10px; display: none;">
      <input type="text" id="novoNome" placeholder="Novo nome">
      <input type="text" id="novoEmail" placeholder="Novo email">
      <input type="text" id="novoLogin" placeholder="Novo login">
      <input type="password" id="novaSenhaAlterar" placeholder="Nova senha (obrigatória p/ atualizar)">
      <button onclick="atualizarUsuario()">Salvar alterações</button>
      <button onclick="excluirUsuarioPorLogin()" style="margin-top: 8px; background-color:#ff4444; width:100%; color:#fff;">Excluir usuário</button>
      <p id="msgAlteracao" class="help"></p>
    </div>
  `));

  // CARD 3: Logs
  grid.appendChild(sectionCard(`
    <h3>Logs de Login</h3>
    <div class="filtros">
      <input type="text" id="filtroUsuarioLog" placeholder="filtrar por login (opcional)">
      <select id="filtroSucesso">
        <option value="">todos</option>
        <option value="1">sucesso</option>
        <option value="0">falha</option>
      </select>
      <button onclick="toggleLogs()">Mostrar / Ocultar</button>
      <button onclick="carregarLogs()">Atualizar</button>
    </div>
    <div id="logsContainer" style="display:none">
      <div id="logsArea"></div>
    </div>
  `));

  // atualiza online periodicamente
  setInterval(mostrarUsuariosOnline, 3000);

  // carregar lista inicial
  filtrarUsuarios();
}

function toggleLogs(){
  const logsDiv = document.getElementById('logsContainer');
  if(!logsDiv) return;
  logsDiv.style.display = logsDiv.style.display === 'none' ? 'block' : 'none';
  if (logsDiv.style.display === 'block') carregarLogs();
}

/* ------------ Auth ------------ */
function login() {
  const usuario = document.getElementById('user').value.trim();
  const senha   = document.getElementById('pass').value;

  // Para teste offline, você pode simular:
  // if (usuario==='admin'){ localStorage.setItem('usuarioLogado', JSON.stringify({usuario:'admin', nome:'Admin', isAdmin:true})); location.reload(); return; }

  fetch('/login', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ usuario, senha })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success){
      localStorage.setItem('usuarioLogado', JSON.stringify(data));
      document.getElementById('loginBox').classList.add('hidden');
      document.getElementById('painelUsuario').classList.remove('hidden');
      document.getElementById('mensagemLogin').innerText = `Bem-vindo(a), ${data.nome}!`;
      if (data.isAdmin) montarPainelAdmin();
      else window.location.href = `dash.html?user=${encodeURIComponent(data.usuario)}`;
    }else{
      alert(data.message || 'Usuário ou senha inválidos!');
    }
  })
  .catch(()=> alert('Sem conexão com o servidor.'));
}

function logout(){
  try{
    const u = JSON.parse(localStorage.getItem('usuarioLogado') || '{}');
    fetch('/logout', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({usuario: u.usuario})});
  }catch{}
  localStorage.removeItem('usuarioLogado');
  location.reload();
}

/* ------------ Cadastro ------------ */
function criarUsuario(){
  const nome    = document.getElementById('nomeUsuario').value.trim();
  const email   = document.getElementById('emailUsuario').value.trim();
  const usuario = document.getElementById('novoUsuario').value.trim();
  const senha   = document.getElementById('novaSenha').value.trim();

  fetch('/usuarios',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ nome, email, usuario, senha })
  })
  .then(res => res.json())
  .then(data => {
    document.getElementById('mensagem').innerText = data.message || (data.success ? 'Criado!' : 'Erro.');
    filtrarUsuarios();
  })
  .catch(()=> document.getElementById('mensagem').innerText = 'Erro ao criar usuário.');
}

/* ------------ Listagem / Alteração / Exclusão ------------ */
function filtrarUsuarios(){
  const q = (document.getElementById('usuarioBusca')?.value || '').trim();
  fetch('/usuarios/busca?q=' + encodeURIComponent(q))
    .then(r=>r.json())
    .then(data => { if(data.success) exibirUsuarios(data.usuarios); })
    .catch(()=>{});
}

function exibirUsuarios(lista){
  const c = document.getElementById('listaUsuarios');
  c.innerHTML = '';
  (lista || []).forEach(u=>{
    const label = (u.usuario && u.usuario.trim()) ? u.usuario : '(sem login)';
    const row = document.createElement('div');
    row.className = 'usuario-item';
    row.innerHTML = `
      <span><strong>${label}</strong> <small>(id: ${u.id})</small></span>
      <button type="button">Editar</button>
    `;
    row.querySelector('button').onclick = () => preencherForm(u);
    c.appendChild(row);
  });
}

function preencherForm(u){
  alvo.id = u.id;                          // sempre teremos ID
  alvo.loginOriginal = (u.usuario || '');  // pode estar vazio
  document.getElementById('formAlteracao').style.display = 'block';
  document.getElementById('novoLogin').value = u.usuario || '';
  document.getElementById('novoNome').value  = u.nome    || '';
  document.getElementById('novoEmail').value = u.email   || '';
  document.getElementById('novaSenhaAlterar').value = '';
  document.getElementById('msgAlteracao').innerText = '';
}

async function atualizarUsuario(){
  const msg = (t)=> document.getElementById('msgAlteracao').innerText = t;
  if(!alvo.id){ msg('Selecione um usuário na lista.'); return; }

  // campos do form
  const novoLogin = document.getElementById('novoLogin').value.trim();
  const novoNome  = document.getElementById('novoNome').value.trim();
  const novoEmail = document.getElementById('novoEmail').value.trim();
  const novaSenha = document.getElementById('novaSenhaAlterar').value;

  // Para registros "vazios", exigimos todos os campos para corrigir de uma vez
  if(!(novoLogin && novoNome && novoEmail && novaSenha)){
    msg('Preencha login, nome, e-mail e uma nova senha para atualizar este usuário.');
    return;
  }

  try{
    // Preferimos atualizar por ID (rota: PUT /usuarios/:id)
    const url = '/usuarios/' + encodeURIComponent(alvo.id);

    const res = await fetch(url, {
      method: 'PUT',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ usuario: novoLogin, senha: novaSenha, nome: novoNome, email: novoEmail })
    }).then(r=>r.json());

    if(res.success){
      msg('Usuário atualizado com sucesso!');
      alvo.loginOriginal = novoLogin; // caso tenha sido definido/corrigido
      filtrarUsuarios();
    }else{
      msg(res.message || res.error || 'Erro ao atualizar.');
    }
  }catch(e){
    console.error(e);
    msg('Erro ao atualizar (ver console).');
  }
}

async function excluirUsuarioPorLogin(){
  const msg = (t)=> document.getElementById('msgAlteracao').innerText = t;
  if(!alvo.id){ msg('Selecione um usuário na lista.'); return; }
  if(!confirm('Excluir este usuário? Essa ação é irreversível.')) return;

  try{
    // Agora deletamos DIRETO por ID (independente do login estar vazio)
    const res = await fetch('/usuarios/' + encodeURIComponent(alvo.id), { method: 'DELETE' })
      .then(r=>r.json());

    if(res.success){
      msg('Usuário excluído com sucesso!');
      alvo = { id:null, loginOriginal:'' };
      document.getElementById('formAlteracao').style.display = 'none';
      filtrarUsuarios();
    }else{
      msg(res.message || res.error || 'Erro ao excluir.');
    }
  }catch(e){
    console.error(e);
    msg('Erro ao excluir (ver console).');
  }
}

/* ------------ Logs / Online ------------ */
function mostrarUsuariosOnline(){
  fetch('/online')
    .then(res=>res.json())
    .then(data=> document.getElementById('usuariosOnline').innerText = `Usuários online: ${data.online}`)
    .catch(()=> document.getElementById('usuariosOnline').innerText = 'Usuários online: erro');
}

function carregarLogs(){
  const u = (document.getElementById('filtroUsuarioLog')?.value || '').trim();
  const s = (document.getElementById('filtroSucesso')?.value || '');
  const qs = new URLSearchParams();
  if (u) qs.set('usuario', u);
  if (s!=='') qs.set('sucesso', s);
  qs.set('limit', 50);

  fetch('/admin/logins?'+qs.toString(), { headers: { 'X-Admin':'1' }})
    .then(res=>res.json())
    .then(data=>{
      const logsDiv = document.getElementById('logsArea');
      logsDiv.innerHTML = '';
      if (!data.success){ logsDiv.innerHTML = '<div style="color:#ff8a8a;">Não autorizado ou erro.</div>'; return; }
      (data.logs||[]).forEach(log=>{
        const d = new Date(log.criado_em);
        const row = document.createElement('div');
        row.className = 'log-item';
        row.innerHTML = `<strong>${log.usuario || '(desconhecido)'}</strong> — ${log.ip} — ${d.toLocaleString()} — ${log.sucesso ? '✔' : '✖'}<br><small>${log.user_agent || ''}</small>`;
        logsDiv.appendChild(row);
      });
      if (!(data.logs||[]).length) logsDiv.innerHTML = '<div style="opacity:.8;">Sem logs ainda.</div>';
    })
    .catch(()=> document.getElementById('logsArea').innerHTML = '<div style="color:#ff8a8a;">Erro ao carregar logs.</div>');
}
</script>
</body>
</html>

