<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Login - SmartFarm</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link id="theme-link" rel="stylesheet" href="login.css" />
  <style>.hidden{display:none}</style>
</head>
<body>
  <div class="shell">
    <!-- LOGIN -->
    <div id="loginBox" class="section login-section text-center">
      <!-- Bot√£o de tema com √≠cone (igual ao dash) -->
      <button id="theme-toggle" onclick="toggleTheme()" class="btn-secondary"
        style="position:absolute; top:10px; right:10px; width:auto; padding:8px; font-size:12px; border:none; cursor:pointer;">
        <img id="themeIcon" src="img/night.png" alt="Tema claro" style="width:20px; height:20px; vertical-align:middle;">
      </button>

      <h1 class="text-primary">
        <img src="/logo.png" alt="SmartFarm" style="height:200px;">
      </h1>
      <p>Login do Usu√°rio</p>
      <input type="text" id="user" placeholder="Login" onkeydown="handleLoginKey(event)" />
      <input type="password" id="pass" placeholder="Senha" onkeydown="handleLoginKey(event)" />
      <button onclick="login()">Entrar</button>
    </div>

    <!-- PAINEL (aparece ap√≥s login) -->
    <div id="painelUsuario" class="section hidden" style="padding: 20px;">
      <div class="painel-head">
        <div>
          <h2 class="text-light">Painel Admin</h2>
          <p id="mensagemLogin" class="text-primary"></p>
        </div>

        <div style="display: flex; gap: 10px; align-items: center;">
          <!-- Bot√£o de tema do painel com √≠cone -->
          <button id="theme-toggle-panel" onclick="toggleTheme()" class="btn-secondary"
            style="width:auto; padding:8px; font-size:12px; background:none; border:none; cursor:pointer;">
            <img id="themeIconPanel" src="img/night.png" alt="Tema claro" style="width:20px; height:20px; vertical-align:middle;">
          </button>

          <button class="botao-logout"
            onclick="logout()"
            style="background-color:red; border:none; border-radius:8px; padding:8px 14px; cursor:pointer; transition:0.2s;"
            onmouseover="this.style.backgroundColor='#cc0000'; this.style.transform='translateY(-1px)';"
            onmouseout="this.style.backgroundColor='red'; this.style.transform='none';">
            <img src="img/exit.png" alt="Sair" style="width:20px; height:20px; vertical-align:middle;">
          </button>
        </div>
      </div>

      <div id="adminArea" class="admin-grid"></div>
    </div>
  </div>

  <!-- Modal Confirmar (SIM/N√£o) -->
  <div id="confirmModal" style="display:none; position:fixed; inset:0; z-index:9999; background: rgba(0,0,0,.7); align-items:center; justify-content:center;">
    <div style="width:min(420px, calc(100% - 32px)); border-radius:14px;">
      <div style="padding:18px 18px 8px; font-weight:700; font-size:18px; border-bottom: 1px solid var(--border-color);">Confirma√ß√£o</div>
      <div id="confirmText" style="padding:15px 18px 18px; line-height:1.5; color: var(--text-muted);"></div>
      <div style="display:flex; gap:10px; justify-content:flex-end; padding:12px 14px; border-radius:0 0 14px 14px;">
        <button id="btnNao" class="btn-secondary" style="padding:10px 16px; width: auto;">N√£o</button>
        <button id="btnSim" style="padding:10px 16px; width: auto;">SIM</button>
      </div>
    </div>
  </div>

<script>
  let dispositivoAbertoId = null;

  // ======================= Altern√¢ncia de Tema (igual ao dash) =======================
  function toggleTheme() {
    const link = document.getElementById('theme-link');
    const iconLogin = document.getElementById('themeIcon');
    const iconPanel = document.getElementById('themeIconPanel');

    const currentTheme = link.getAttribute('href');
    let newTheme = '';
    let newIcon = '';
    let newAlt  = '';

    if (currentTheme === 'login.css') {
      // indo para dark
      newTheme = 'login_dark.css';
      newIcon  = 'img/day.png';
      newAlt   = 'Tema escuro';
    } else {
      // voltando para claro
      newTheme = 'login.css';
      newIcon  = 'img/night.png';
      newAlt   = 'Tema claro';
    }

    link.setAttribute('href', newTheme);
    // chave dedicada ao login para n√£o conflitar com dash
    localStorage.setItem('loginTheme', newTheme);

    if (iconLogin) { iconLogin.src = newIcon; iconLogin.alt = newAlt; }
    if (iconPanel) { iconPanel.src = newIcon; iconPanel.alt = newAlt; }
  }

  // Aplica o tema salvo ao carregar e ajusta os √≠cones
  document.addEventListener('DOMContentLoaded', () => {
    const savedTheme = localStorage.getItem('loginTheme');
    const link = document.getElementById('theme-link');
    const iconLogin = document.getElementById('themeIcon');
    const iconPanel = document.getElementById('themeIconPanel');

    if (savedTheme && savedTheme !== 'login.css') {
      link.setAttribute('href', savedTheme);
      if (iconLogin) { iconLogin.src = 'img/day.png'; iconLogin.alt = 'Tema escuro'; }
      if (iconPanel) { iconPanel.src = 'img/day.png'; iconPanel.alt = 'Tema escuro'; }
    } else {
      if (link.getAttribute('href') !== 'login.css') link.setAttribute('href', 'login.css');
      if (iconLogin) { iconLogin.src = 'img/night.png'; iconLogin.alt = 'Tema claro'; }
      if (iconPanel) { iconPanel.src = 'img/night.png'; iconPanel.alt = 'Tema claro'; }
    }
  });

  // ======================= Login =======================
  function handleLoginKey(event) {
    if (event.key === 'Enter') {
      event.preventDefault();
      login();
    }
  }

  /* =======================
     Sess√£o existente
     ======================= */
  async function verificarSessaoExistente() {
    try {
      const r = await fetch('/session', { credentials: 'include' });
      const data = await r.json();

      if (!data.authenticated) return; // mostra login

      // tenta determinar admin pelo backend, pelo nome do usu√°rio ou pelo localStorage
      const fromLS = JSON.parse(localStorage.getItem('usuarioLogado') || 'null');
      const deduzAdmin = (x) => !!(x && (x.isAdmin === true || x.usuario === 'admin'));

      const isAdmin =
        (data && (data.isAdmin === true || data.usuario === 'admin')) ||
        deduzAdmin(fromLS);

      if (isAdmin) {
        // mant√©m na p√°gina admin (login.html) e monta o painel
        const payload = {
          authenticated: true,
          usuario: data.usuario || (fromLS && fromLS.usuario) || 'admin',
          nome: data.nome || (fromLS && fromLS.nome) || 'Administrador',
          isAdmin: true
        };
        localStorage.setItem('usuarioLogado', JSON.stringify(payload));
        document.getElementById('loginBox').classList.add('hidden');
        document.getElementById('painelUsuario').classList.remove('hidden');
        document.getElementById('mensagemLogin').innerText = `Bem-vindo(a), ${payload.nome}!`;
        montarPainelAdmin();
        return;
      }

      // se n√£o for admin, manda pro dashboard
      window.location.href = 'dash.html';
    } catch (e) {
      // n√£o faz nada: mostra o formul√°rio de login
      console.log('Sess√£o n√£o p√¥de ser verificada:', e);
    }
  }
  verificarSessaoExistente();

  let alvo = { id: null, loginOriginal: "" };

  /* =======================
     Auto-montagem se j√° logado (localStorage)
     ======================= */
  window.onload = () => {
    const dados = localStorage.getItem('usuarioLogado');
    if (dados) {
      const user = JSON.parse(dados);
      document.getElementById('loginBox').classList.add('hidden');
      document.getElementById('painelUsuario').classList.remove('hidden');
      document.getElementById('mensagemLogin').innerText = `Bem-vindo(a), ${user.nome}!`;

      if (user.isAdmin && !document.getElementById('adminCardsBuilt')) {
        montarPainelAdmin();
      } else {
        fetch(`/usuarios?login=${encodeURIComponent(user.usuario)}`)
          .then(res => res.json())
          .then(resp => {
            const lista = Array.isArray(resp) ? resp : (resp.usuarios || []);
            if (lista.length > 0) {
              const isAdmin = lista[0].usuario === 'admin';
              if (isAdmin && !document.getElementById('adminCardsBuilt')) montarPainelAdmin();
            }
          })
          .catch(()=>{});
      }
    }
  };

  /* ------------ UI helpers ------------ */
  function sectionCard(html){
    const wrap = document.createElement('div');
    wrap.className = 'card';
    wrap.innerHTML = `<div class="card-content">${html}</div>`;
    return wrap;
  }

  /* =======================
     Montagem do Painel Admin
     ======================= */
  function montarPainelAdmin() {
    if (document.getElementById('adminCardsBuilt')) return;
    const grid = document.getElementById('adminArea');
    grid.id = 'adminCardsBuilt';

    // CARD 1: Cadastro
    grid.appendChild(sectionCard(`
      <h3>Cadastro</h3>
      <p id="usuariosOnline" class="help text-primary">Usu√°rios online: carregando...</p>
      <input type="text" id="nomeUsuario" placeholder="Nome do novo usu√°rio">
      <input type="email" id="emailUsuario" placeholder="E-mail do novo usu√°rio">
      <input type="text" id="novoUsuario" placeholder="Login do novo usu√°rio">
      <input type="password" id="novaSenha" placeholder="Senha">
      <button onclick="criarUsuario()">Criar novo usu√°rio</button>
      <p id="mensagem" class="help"></p>
    `));

    // CARD 2: Alterar/Excluir
    grid.appendChild(sectionCard(`
      <h3>Alterar Usu√°rio</h3>
      <p class="help text-muted">* Digite para filtrar; deixe vazio para listar todos.</p>
      <input type="text" id="usuarioBusca" placeholder="Login do usu√°rio a alterar" oninput="filtrarUsuarios()" autocomplete="off">
      <div id="listaUsuarios" style="max-height: 300px; overflow-y: auto; padding-right: 5px;"></div>
      <div id="formAlteracao" style="display: none;">
        <input type="text" id="novoNome" placeholder="Novo nome">
        <input type="text" id="novoEmail" placeholder="Novo email">
        <input type="text" id="novoLogin" placeholder="Novo login">
        <input type="password" id="novaSenhaAlterar" placeholder="Nova senha (obrigat√≥ria p/ atualizar)">
        <button onclick="atualizarUsuario()">Salvar altera√ß√µes</button>
        <button onclick="excluirUsuarioPorLogin()" class="btn-danger" style="margin-top: 8px;">Excluir usu√°rio</button>
        <p id="msgAlteracao" class="help"></p>
      </div>
    `));

    // CARD 3: Gerenciar Dispositivos
    grid.appendChild(sectionCard(`
      <h3>Gerenciar Dispositivos</h3>

      <div class="disp-toolbar">
        <button id="btnAtualizarDisps">Atualizar lista</button>
        <input id="novoSerial" type="text" placeholder="Serial do ESP32">
        <button id="btnAddSerial">Adicionar dispositivo</button>
      </div>

      <div id="listaDispositivos" style="margin-top:10px; max-height: 300px; overflow-y: auto; padding-right: 5px;"></div>
      <small class="text-muted">Mostrando somente dispositivos vinculados a algum usu√°rio.</small>
    `));

    // CARD 4: Logs
    grid.appendChild(sectionCard(`
      <h3>Logs de Login</h3>
      <div class="filtros">
        <input type="text" id="filtroUsuarioLog" placeholder="filtrar por login (opcional)">
        <select id="filtroSucesso">
          <option value="">todos</option>
          <option value="1">sucesso</option>
          <option value="0">falha</option>
        </select>
        <button onclick="toggleLogs()">Mostrar / Ocultar</button>
        <button onclick="carregarLogs()">Atualizar</button>
      </div>
      <div id="logsContainer" style="display:none; margin-top: 15px;">
        <div id="logsArea"></div>
      </div>
    `));

    // Wires
    document.getElementById('btnAtualizarDisps')
      .addEventListener('click', carregarDispositivosAdmin);

    document.getElementById('btnAddSerial')
      .addEventListener('click', adicionarSerial);

    // Atualiza online periodicamente
    setInterval(mostrarUsuariosOnline, 3000);

    // Inicializa√ß√µes
    filtrarUsuarios();
    carregarDispositivosAdmin();
  }

  /* ------------ Auth ------------ */
  function login() {
    const usuario = document.getElementById('user').value.trim();
    const senha   = document.getElementById('pass').value;

    fetch('/login', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      credentials: 'include',
      body: JSON.stringify({ usuario, senha })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success){
        localStorage.setItem('usuarioLogado', JSON.stringify(data));
        document.getElementById('loginBox').classList.add('hidden');
        document.getElementById('painelUsuario').classList.remove('hidden');
        document.getElementById('mensagemLogin').innerText = `Bem-vindo(a), ${data.nome}!`;
        if (data.isAdmin) montarPainelAdmin();
        else window.location.href = 'dash.html';
      }else{
        alert(data.message || 'Usu√°rio ou senha inv√°lidos!');
      }
    })
    .catch(()=> alert('Sem conex√£o com o servidor.'));
  }

  function logout(){
    try{
      const u = JSON.parse(localStorage.getItem('usuarioLogado') || '{}');
      fetch('/logout', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({usuario: u.usuario})});
    }catch{}
    localStorage.removeItem('usuarioLogado');
    location.reload();
  }

  /* ------------ Cadastro ------------ */
  function criarUsuario(){
    const nome    = document.getElementById('nomeUsuario').value.trim();
    const email   = document.getElementById('emailUsuario').value.trim();
    const usuario = document.getElementById('novoUsuario').value.trim();
    const senha   = document.getElementById('novaSenha').value.trim();

    fetch('/usuarios',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ nome, email, usuario, senha })
    })
    .then(res => res.json())
    .then(data => {
      document.getElementById('mensagem').innerText = data.message || (data.success ? 'Criado!' : 'Erro.');
      filtrarUsuarios();
    })
    .catch(()=> document.getElementById('mensagem').innerText = 'Erro ao criar usu√°rio.');
  }

  // Modal confirm "SIM/N√£o" (auto-contido) ‚Äî usado em a√ß√µes admin
  async function confirmar(mensagemHTML) {
    return new Promise((resolve) => {
      const ov = document.createElement('div');
      ov.style.cssText = `
        position:fixed; inset:0; background:rgba(0,0,0,.55);
        display:flex; align-items:center; justify-content:center;
        z-index: 9999; backdrop-filter: blur(2px);
      `;

      const box = document.createElement('div');
      box.style.cssText = `
        width:min(520px, calc(100% - 32px));
        background:#0e1c1a; color:#e8fff6; border:1px solid #24443d;
        border-radius:14px; box-shadow:0 20px 60px rgba(0,0,0,.45);
        overflow:hidden; font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial;
      `;
      box.innerHTML = `
        <div style="padding:14px 18px; font-weight:700; border-bottom:1px solid #1b2f2b">Confirma√ß√£o</div>
        <div style="padding:16px 18px; font-size:14px; line-height:1.45;">${mensagemHTML}</div>
        <div style="display:flex; gap:12px; padding:14px 18px; background:#0b1715; border-top:1px solid #1b2f2b; justify-content:flex-end;">
          <button id="btnNao" style="padding:10px 14px; border-radius:10px; border:1px solid #2a3e39; background:#142825; color:#cfeee6; cursor:pointer; min-width:90px;">N√£o</button>
          <button id="btnSim" style="padding:10px 14px; border-radius:10px; border:1px solid #12d6b1; background:#12d6b1; color:#003b32; font-weight:700; cursor:pointer; min-width:90px;">SIM</button>
        </div>
      `;

      ov.appendChild(box);
      document.body.appendChild(ov);

      const cleanup = (val) => {
        try { document.body.removeChild(ov); } catch {}
        resolve(val);
      };

      box.querySelector('#btnNao').addEventListener('click', () => cleanup(false));
      box.querySelector('#btnSim').addEventListener('click', () => cleanup(true));

      const keyH = (e) => {
        if (e.key === 'Escape') { e.preventDefault(); cleanup(false); }
        if (e.key === 'Enter')  { e.preventDefault(); cleanup(true); }
      };
      setTimeout(() => document.addEventListener('keydown', keyH), 0);

      const obs = new MutationObserver(() => {
        if (!document.body.contains(ov)) document.removeEventListener('keydown', keyH);
      });
      obs.observe(document.body, { childList: true });
    });
  }

  /* ------------ Dispositivos (Admin) ------------ */
  function renderDispositivoItem(d){
    const wrap = document.createElement('div');
    wrap.className = 'disp-item';
    wrap.id = `disp-${d.id}`;

    const head = document.createElement('div');
    head.className = 'disp-head';
    head.innerHTML = `
      <div class="disp-title">
        <div style="font-weight:700">${d.serialnumber}</div>
        <small>Usu√°rio atual: ${d.usuario_login || '‚Äî'}${d.fk_usuarios ? ` (id: ${d.fk_usuarios})` : ''} ‚Ä¢ Cultura: ${d.nome_cultura || 'Sem cultura'}</small>
      </div>
      <div class="disp-chevron">‚ñ∏</div>
    `;

    const body = document.createElement('div');
    body.className = 'disp-body';
    body.innerHTML = `
      <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap">
        <label style="font-size:12px;opacity:.85">Vincular ao usu√°rio (ID):</label>
        <input type="number" placeholder="ID usu√°rio" id="user-${d.id}"
               value="${d.fk_usuarios || ''}"
               style="padding:6px 8px;width:160px;text-align:center;border-radius:8px;border:1px solid #2d3f3a;background:#0b1715;color:#e8fff6;">
      </div>
      <div class="disp-actions">
        <button class="btn" data-update="${d.id}" style="background:#00b894;color:#fff;">Alterar usu√°rio</button>
        <button class="btn" data-unlink="${d.id}" style="background:#ff4444;color:#fff;">üîó Desvincular</button>
      </div>
    `;

    wrap.appendChild(head);
    wrap.appendChild(body);

    const chevron = head.querySelector('.disp-chevron');
    const toggle = () => {
      const aberto = body.style.display === 'block';
      if (dispositivoAbertoId && dispositivoAbertoId !== d.id) {
        const prev = document.getElementById(`disp-${dispositivoAbertoId}`);
        if (prev) {
          prev.querySelector('.disp-body').style.display = 'none';
          const ch = prev.querySelector('.disp-chevron');
          if (ch) ch.style.transform = 'rotate(0deg)';
        }
      }
      if (aberto){
        body.style.display = 'none';
        chevron.style.transform = 'rotate(0deg)';
        dispositivoAbertoId = null;
      }else{
        body.style.display = 'block';
        chevron.style.transform = 'rotate(90deg)';
        dispositivoAbertoId = d.id;
      }
    };
    head.addEventListener('click', toggle);

    const doUpdate = async () => {
      try {
        const inp = body.querySelector(`#user-${d.id}`);
        const fk_usuarios = parseInt((inp.value || '').trim(), 10);
        if (!fk_usuarios) { alert('Informe um ID de usu√°rio v√°lido.'); inp.focus(); return; }

        const ok = await confirmar(`Alterar o ESP32 <b>${d.serialnumber}</b> para o usu√°rio ID <b>${fk_usuarios}</b>?`);
        if(!ok) return;

        const r = await fetch(`/esp32/dispositivos/${d.id}/usuario`, {
          method:'PUT',
          headers:{'Content-Type':'application/json'},
          credentials:'include',
          body: JSON.stringify({ fk_usuarios })
        });
        const out = await r.json().catch(() => ({}));

        if (r.ok && out.success){
          alert('‚úÖ Usu√°rio do dispositivo atualizado com sucesso!');
          carregarDispositivosAdmin();
        } else {
          alert(out.message || `Erro ao atualizar (HTTP ${r.status}).`);
        }
      } catch (err) {
        console.error('Erro no update', err);
        alert('Falha de rede ou erro inesperado.');
      }
    };

    body.querySelector(`[data-update="${d.id}"]`).addEventListener('click', (ev)=>{
      ev.stopPropagation();
      doUpdate();
    });
    body.querySelector(`#user-${d.id}`).addEventListener('keydown', (ev)=>{
      if(ev.key === 'Enter') { ev.stopPropagation(); doUpdate(); }
    });

    body.querySelector(`[data-unlink="${d.id}"]`).addEventListener('click', async (ev)=>{
      ev.stopPropagation();
      const ok = await confirmar(`Desvincular o dispositivo <b>${d.serialnumber}</b> do usu√°rio atual?`);
      if(!ok) return;

      try{
        const r = await fetch(`/admin/esp32/dispositivos/${d.id}/vinculo`, {
          method:'DELETE',
          credentials:'include'
        });
        const out = await r.json().catch(()=> ({}));

        if(r.ok && out.success){
          alert('‚úÖ Dispositivo desvinculado com sucesso!');
          carregarDispositivosAdmin();
        }else{
          alert(out.message || `Erro ao desvincular (HTTP ${r.status}).`);
        }
      }catch(err){
        console.error('Erro ao desvincular', err);
        alert('Falha de rede ao desvincular.');
      }
    });

    return wrap;
  }

  async function carregarDispositivosAdmin(){
    const lista = document.getElementById('listaDispositivos');
    lista.innerHTML = '<p style="opacity:.7">Carregando...</p>';
    try{
      const r = await fetch('/esp32/dispositivos/ativos', { credentials:'include' });
      const data = await r.json();
      if (!r.ok || !data.success){
        throw new Error(data.message || data.error || 'Falha ao listar');
      }
      if (!data.dispositivos?.length){
        lista.innerHTML = '<p style="opacity:.7">Nenhum dispositivo vinculado.</p>';
        return;
      }
      lista.innerHTML = '';
      data.dispositivos.forEach(d => lista.appendChild(renderDispositivoItem(d)));
    }catch(err){
      console.error(err);
      lista.innerHTML = '<p style="color:#ff4444">Erro ao carregar.</p>';
    }
  }

  async function adicionarSerial(){
    const inp = document.getElementById('novoSerial');
    const serial = (inp.value || '').trim();
    if(!serial) { alert('Informe o serial.'); return; }
    try{
      const r = await fetch('/esp32/dispositivos', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        credentials:'include',
        body: JSON.stringify({ serial })
      });
      const out = await r.json();
      if(r.ok && out.success){
        inp.value = '';
        alert('Serial adicionado!');
        carregarDispositivosAdmin();
      }else{
        alert(out.message || 'Erro ao adicionar.');
      }
    }catch(e){
      alert('Falha de rede.');
    }
  }

  /* ------------ Usu√°rios: listar/editar/excluir ------------ */
  function filtrarUsuarios(){
    const q = (document.getElementById('usuarioBusca')?.value || '').trim();
    fetch('/usuarios/busca?q=' + encodeURIComponent(q))
      .then(r=>r.json())
      .then(data => { if(data.success) exibirUsuarios(data.usuarios); })
      .catch(()=>{});
  }

  function exibirUsuarios(lista){
    const c = document.getElementById('listaUsuarios');
    c.innerHTML = '';
    (lista || []).forEach(u=>{
      const label = (u.usuario && u.usuario.trim()) ? u.usuario : '(sem login)';
      const row = document.createElement('div');
      row.className = 'usuario-item';
      row.innerHTML = `
        <span><strong>${label}</strong> <small>(id: ${u.id})</small></span>
        <button type="button">Editar</button>
      `;
      row.querySelector('button').onclick = () => preencherForm(u);
      c.appendChild(row);
    });
  }

  function preencherForm(u){
    alvo.id = u.id;
    alvo.loginOriginal = (u.usuario || '');
    document.getElementById('formAlteracao').style.display = 'block';
    document.getElementById('novoLogin').value = u.usuario || '';
    document.getElementById('novoNome').value  = u.nome    || '';
    document.getElementById('novoEmail').value = u.email   || '';
    document.getElementById('novaSenhaAlterar').value = '';
    document.getElementById('msgAlteracao').innerText = '';
  }

  async function atualizarUsuario(){
    const msg = (t)=> document.getElementById('msgAlteracao').innerText = t;
    if(!alvo.id){ msg('Selecione um usu√°rio na lista.'); return; }

    const novoLogin = document.getElementById('novoLogin').value.trim();
    const novoNome  = document.getElementById('novoNome').value.trim();
    const novoEmail = document.getElementById('novoEmail').value.trim();
    const novaSenha = document.getElementById('novaSenhaAlterar').value;

    if(!(novoLogin && novoNome && novoEmail && novaSenha)){
      msg('Preencha login, nome, e-mail e uma nova senha para atualizar este usu√°rio.');
      return;
    }

    try{
      const url = '/usuarios/' + encodeURIComponent(alvo.id);
      const res = await fetch(url, {
        method: 'PUT',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ usuario: novoLogin, senha: novaSenha, nome: novoNome, email: novoEmail })
      }).then(r=>r.json());

      if(res.success){
        msg('Usu√°rio atualizado com sucesso!');
        alvo.loginOriginal = novoLogin;
        filtrarUsuarios();
      }else{
        msg(res.message || res.error || 'Erro ao atualizar.');
      }
    }catch(e){
      console.error(e);
      msg('Erro ao atualizar (ver console).');
    }
  }

  async function excluirUsuarioPorLogin(){
    const msg = (t)=> document.getElementById('msgAlteracao').innerText = t;
    if(!alvo.id){ msg('Selecione um usu√°rio na lista.'); return; }
    if(!confirm('Excluir este usu√°rio? Essa a√ß√£o √© irrevers√≠vel.')) return;

    try{
      const res = await fetch('/usuarios/' + encodeURIComponent(alvo.id), { method: 'DELETE' })
        .then(r=>r.json());

      if(res.success){
        msg('Usu√°rio exclu√≠do com sucesso!');
        alvo = { id:null, loginOriginal:'' };
        document.getElementById('formAlteracao').style.display = 'none';
        filtrarUsuarios();
      }else{
        msg(res.message || res.error || 'Erro ao excluir.');
      }
    }catch(e){
      console.error(e);
      msg('Erro ao excluir (ver console).');
    }
  }

  /* ------------ Logs / Online ------------ */
  function mostrarUsuariosOnline(){
    fetch('/online')
      .then(res=>res.json())
      .then(data=> document.getElementById('usuariosOnline').innerText = `Usu√°rios online: ${data.online}`)
      .catch(()=> document.getElementById('usuariosOnline').innerText = 'Usu√°rios online: erro');
  }

  function toggleLogs(){
    const logsDiv = document.getElementById('logsContainer');
    if(!logsDiv) return;
    logsDiv.style.display = logsDiv.style.display === 'none' ? 'block' : 'none';
    if (logsDiv.style.display === 'block') carregarLogs();
  }

  function carregarLogs(){
    const u = (document.getElementById('filtroUsuarioLog')?.value || '').trim();
    const s = (document.getElementById('filtroSucesso')?.value || '');
    const qs = new URLSearchParams();
    if (u) qs.set('usuario', u);
    if (s!=='') qs.set('sucesso', s);
    qs.set('limit', 50);

    fetch('/admin/logins?'+qs.toString(), { headers: { 'X-Admin':'1' }})
      .then(res=>res.json())
      .then(data=>{
        const logsDiv = document.getElementById('logsArea');
        logsDiv.innerHTML = '';
        if (!data.success){ logsDiv.innerHTML = '<div style="color:#ff8a8a;">N√£o autorizado ou erro.</div>'; return; }
        (data.logs||[]).forEach(log=>{
          const d = new Date(log.criado_em);
          const row = document.createElement('div');
          row.className = 'log-item';
          row.innerHTML = `<strong>${log.usuario || '(desconhecido)'}</strong> ‚Äî ${log.ip} ‚Äî ${d.toLocaleString()} ‚Äî ${log.sucesso ? '‚úî' : '‚úñ'}<br><small>${log.user_agent || ''}</small>`;
          logsDiv.appendChild(row);
        });
        if (!(data.logs||[]).length) logsDiv.innerHTML = '<div style="opacity:.8;">Sem logs ainda.</div>';
      })
      .catch(()=> document.getElementById('logsArea').innerHTML = '<div style="color:#ff8a8a;">Erro ao carregar logs.</div>');
  }
</script>
</body>
</html>
